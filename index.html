<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tx App</title>

  <!-- Farcaster Manifest Link -->
  <link rel="manifest" href="/farcaster.json">
  <link rel="icon" type="image/png" href="https://monad-snowy.vercel.app/.well-known/icon.png">
  
  <!-- Farcaster Meta with Dynamic Content -->
  <meta name="fc:frame" content='{
    "version": "next",
    "imageUrl": "https://monad-snowy.vercel.app/.well-known/share.png",
    "button": {
      "title": "üöÄ Play Tx App",
      "action": {
        "type": "launch_frame",
        "url": "https://monad-snowy.vercel.app",
        "name": "Tx App",
        "splashImageUrl": "https://monad-snowy.vercel.app/.well-known/splash.png",
        "splashBackgroundColor": "#001f3f"
      }
    }
  }' />

  <!-- Open Graph for better sharing -->
  <meta property="og:title" content="Tx App - Deploy, Pet, Greet, Flip on Base Mainnet" />
  <meta property="og:description" content="Interactive Farcaster Mini App on Base Mainnet. Deploy tokens, pet the dog, say GM/GN, flip coins and earn XP!" />
  <meta property="og:image" content="https://monad-snowy.vercel.app/.well-known/share.png" />
  <meta property="og:url" content="https://monad-snowy.vercel.app" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Tx App - Deploy, Pet, Greet, Flip on Base Mainnet" />
  <meta name="twitter:description" content="Interactive Farcaster Mini App on Base Mainnet. Deploy tokens, pet the dog, say GM/GN, flip coins and earn XP!" />
  <meta name="twitter:image" content="https://monad-snowy.vercel.app/.well-known/share.png" />

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <!-- Farcaster Mini App SDK -->
  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/frame-sdk';
    
    // Mini App ready when loaded
    window.addEventListener('load', async () => {
      try {
        await sdk.actions.ready();
        console.log('Farcaster Mini App ready!');
        
        // Make SDK available globally
        window.farcasterSDK = sdk;
      } catch (error) {
        console.log('Not running in Farcaster client:', error);
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #001f3f 0%, #003d7a 100%);
      color: white;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 400px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .social-link {
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      transition: all 0.3s ease;
      margin-top: 15px;
    }
    
    .social-link:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.1);
    }
    
    .social-link svg {
      width: 20px;
      height: 20px;
      fill: white;
    }
    
    .xp {
      background: rgba(255,255,255,0.1);
      padding: 10px 20px;
      border-radius: 20px;
      display: inline-block;
      margin-bottom: 20px;
    }
    
    .wallet-section {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin: 10px 0;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .tabs {
      display: flex;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    .tabs-bottom {
      margin-top: 20px;
      margin-bottom: 10px;
      justify-content: center;
    }
    
    .tabs-bottom .tab {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      color: white;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .tabs-bottom .tab:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }
    
    .tab {
      flex: 1;
      padding: 12px;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    
    .tab.active {
      background: #007bff;
    }
    
    .content {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      min-height: 200px;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .dog-image {
      width: 200px;
      height: 200px;
      border-radius: 12px;
      margin: 20px auto;
      display: block;
    }
    
    .coin {
      font-size: 60px;
      margin: 20px;
      transition: transform 0.5s;
    }
    
    .status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      display: none;
    }
    
    .status.visible {
      display: block;
    }
    
    .status.success {
      background: rgba(0,255,0,0.2);
      color: #00ff00;
    }
    
    .status.error {
      background: rgba(255,0,0,0.2);
      color: #ff6b6b;
    }
    
    .status.pending {
      background: rgba(255,255,0,0.2);
      color: #ffeb3b;
    }
    
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #001f3f 0%, #003d7a 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255,255,255,0.2);
      border-radius: 50%;
      border-top-color: #007bff;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .loading-text {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      animation: pulse 2s ease-in-out infinite;
    }

    .loading-subtitle {
      font-size: 14px;
      opacity: 0.7;
      text-align: center;
      max-width: 280px;
      line-height: 1.4;
    }

    .loading-progress {
      width: 200px;
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
      margin-top: 20px;
      overflow: hidden;
    }

    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #007bff, #0056b3);
      border-radius: 2px;
      width: 0%;
      transition: width 0.3s ease;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Skeleton Loading States */
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
    }

    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-text {
      height: 16px;
      border-radius: 4px;
      margin: 8px 0;
    }

    .skeleton-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .skeleton-button {
      height: 44px;
      border-radius: 8px;
      margin: 10px 0;
    }

    /* Hide content initially to prevent layout shift */
    .app-content {
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .app-content.loaded {
      opacity: 1;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    
    th {
      background: rgba(255,255,255,0.1);
    }
    
    .address {
      font-family: monospace;
      font-size: 12px;
    }

    .badge {
      background: #ff6b9d;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
      margin-left: 8px;
    }

    /* Network Selector Styles */
    .network-selector {
      display: flex;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 4px;
      margin: 15px 0;
      gap: 4px;
    }

    .network-btn {
      flex: 1;
      background: none;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.3s ease;
      opacity: 0.7;
    }

    .network-btn:hover {
      opacity: 0.9;
      background: rgba(255,255,255,0.1);
    }

    .network-btn.active {
      background: #007bff;
      opacity: 1;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }

    .network-icon {
      font-size: 14px;
    }

    /* Custom network icons */
    .app-logo {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .logo-icon {
      width: 80px;
      height: 80px;
      background: #007bff;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      font-weight: bold;
      color: white;
      box-shadow: 0 0 30px rgba(0, 123, 255, 0.5);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .logo-icon::after {
      content: '';
      position: absolute;
      width: 80px;
      height: 80px;
      background: #007bff;
      border-radius: 20px;
      opacity: 0.3;
      filter: blur(20px);
      z-index: -1;
    }
    
    .monad-icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0056b3, #a855f7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      color: white;
      margin-right: 4px;
    }

    .base-icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      color: white;
      margin-right: 4px;
    }

    /* Lucky Number Styles */
    .number-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin: 20px 0;
    }

    .number-btn {
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      color: white;
      font-size: 18px;
      font-weight: bold;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .number-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.4);
      transform: scale(1.05);
    }

    .number-btn.selected {
      background: linear-gradient(135deg, #00ff88, #00d4ff);
      border-color: #00ff88;
      color: #000;
      transform: scale(1.1);
    }

    .selected-info {
      background: rgba(0,255,136,0.1);
      border: 1px solid rgba(0,255,136,0.3);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }

    .selected-value {
      font-weight: bold;
      color: #00ff88;
      font-size: 20px;
    }

    /* Token Deploy Styles */
    .token-form {
      background: rgba(0,0,0,0.2);
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #e5e7eb;
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(0,0,0,0.3);
      color: white;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 10px rgba(99, 102, 241, 0.3);
    }

    .form-group input::placeholder {
      color: rgba(255,255,255,0.5);
    }

    .network-name {
      font-size: 11px;
      font-weight: 600;
    }

    .rank-number {
      font-weight: 600;
      color: #007bff;
      width: 40px;
    }

    .address-cell {
      font-family: monospace;
      font-size: 12px;
    }

    .share-button {
      background: linear-gradient(45deg, #007bff, #0056b3);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin: 10px 5px;
      width: auto;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .share-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
    }

    .share-section {
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .achievement-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .achievement-content {
      background: linear-gradient(135deg, #001f3f 0%, #003d7a 100%);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 350px;
      border: 2px solid #007bff;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    }

    .achievement-icon {
      font-size: 60px;
      margin-bottom: 15px;
      animation: bounce 0.6s ease;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }

    .close-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      width: auto;
      padding: 5px;
      opacity: 0.8;
      transition: opacity 0.2s;
    }
    
    .close-modal:hover {
      opacity: 1;
    }

    /* Token Claim Styles */
    .token-stats {
      background: linear-gradient(135deg, #f59e0b, #eab308);
      padding: 8px 16px;
      border-radius: 20px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-left: 10px;
      font-size: 14px;
      font-weight: 600;
    }

    .claim-section {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .claim-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .claim-info-item {
      text-align: center;
    }

    .claim-info-label {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 5px;
    }

    .claim-info-value {
      font-size: 20px;
      font-weight: 600;
      color: #f59e0b;
    }

    .claim-button {
      background: linear-gradient(135deg, #f59e0b, #eab308);
      color: white;
      font-weight: 600;
      padding: 14px 28px;
      border-radius: 12px;
      width: 100%;
      margin-top: 10px;
      transition: all 0.3s ease;
    }

    .claim-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4);
    }

    .claim-button:disabled {
      background: rgba(255,255,255,0.1);
      cursor: not-allowed;
    }

    .token-balance {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      padding: 10px;
      background: rgba(245, 158, 11, 0.1);
      border-radius: 8px;
      font-size: 14px;
    }

    .conversion-rate {
      text-align: center;
      font-size: 12px;
      opacity: 0.7;
      margin-top: 8px;
    }

    .claim-history {
      margin-top: 20px;
      font-size: 12px;
      opacity: 0.7;
    }

    .claim-history-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    /* Slots Machine Styles */
    .slots-machine {
      background: rgba(255,255,255,0.1);
      padding: 25px;
      border-radius: 16px;
      margin: 20px 0;
      border: 2px solid rgba(255,255,255,0.2);
    }

    .slots-display {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 25px 0;
      padding: 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      border: 2px solid #007bff;
    }

    .slot-reel {
      width: 70px;
      height: 70px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      border: 2px solid rgba(255,255,255,0.3);
      transition: all 0.3s ease;
    }

    .slot-reel.spinning {
      animation: spin-reel 0.1s linear infinite;
    }

    .slot-reel.winning {
      background: rgba(16, 185, 129, 0.3);
      border-color: #10b981;
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    }

    @keyframes spin-reel {
      0% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
      100% { transform: translateY(0); }
    }

    .slots-info {
      display: flex;
      justify-content: space-between;
      margin: 15px 0;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }

    .slots-button {
      background: linear-gradient(135deg, #f59e0b, #eab308);
      color: white;
      font-weight: 600;
      padding: 16px 32px;
      border-radius: 12px;
      width: 100%;
      margin: 15px 0;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .slots-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4);
    }

    .slots-button:disabled {
      background: rgba(255,255,255,0.1);
      cursor: not-allowed;
      transform: none;
    }

    .slots-legend {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
    }

    .symbol-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .symbol-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }

    .symbol {
      font-size: 24px;
    }

    .symbol-name {
      font-size: 14px;
      opacity: 0.8;
    }

    .slots-jackpot {
      background: linear-gradient(135deg, #ffd700, #ffed4a);
      color: #1a1a1a;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      text-align: center;
      font-weight: 600;
      animation: jackpot-glow 2s ease-in-out infinite;
    }

    @keyframes jackpot-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
      50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); }
    }
  </style>
</head>
<body>
  <div class="container app-content">
    <div class="header">
      <div class="app-logo">
        <div class="logo-icon">Tx</div>
      </div>
      <div class="title">Tx App</div>
      <div class="xp" id="xp-display">‚ú® Available XP: <span id="xp">0</span></div>
    </div>

    <div class="wallet-section">
      <div id="connect-area">
        <button id="connect-btn">üü£ Connect Wallet</button>
      </div>
      <div id="connected-area" style="display: none;">
        <div>üü£ Connected</div>
        <div id="address" class="address"></div>
        <button id="disconnect-btn">Disconnect</button>
      </div>
      
    </div>

        <div class="tabs" id="main-tabs">
          <button class="tab active" onclick="showTab('pet')">üêï Pet</button>
          <button class="tab" onclick="showTab('greet')">üëã Greet</button>
          <button class="tab" onclick="showTab('flip')">ü™ô Flip</button>
          <button class="tab" onclick="showTab('slots')">üé∞ Slots</button>
          <button class="tab" onclick="showTab('lucky')">üçÄ Lucky</button>
          <button class="tab" onclick="showTab('deploy')">üöÄ Deploy</button>
        </div>
        

    <div class="content">
      <!-- Pet Tab -->
      <div id="pet" class="tab-content active">
        <h3>Pet the Dog</h3>
        <img id="dog-img" class="dog-image" src="https://placedog.net/400/300?id=7" alt="Dog">
        <button onclick="petDog()">üëã Pet Dog (+10 XP)</button>
        <div id="pet-status" class="status"></div>
        
        <div class="share-section">
          <button class="share-button" onclick="sharePetAchievement()">
            üêï Share Pet Achievement
          </button>
        </div>
      </div>

      <!-- Greet Tab -->
      <div id="greet" class="tab-content">
        <h3>Greet Community</h3>
        <p>Say GM or GN to the community!</p>
        <button onclick="sayGM()">‚òÄÔ∏è Good Morning (+5 XP)</button>
        <button onclick="sayGN()">üåô Good Night (+5 XP)</button>
        <div id="greet-status" class="status"></div>
        
        <div class="share-section">
          <button class="share-button" onclick="shareGreetAchievement()">
            üëã Share Community Spirit
          </button>
        </div>
      </div>

      <!-- Flip Tab -->
      <div id="flip" class="tab-content">
        <h3>Flip Coin</h3>
        <div class="coin" id="coin">ü™ô</div>
        <button onclick="flipCoin()">üé≤ Flip Coin (+3 XP)</button>
        <div id="flip-result">Result will appear here</div>
        <div id="flip-status" class="status"></div>
        
        <div class="share-section">
          <button class="share-button" onclick="shareFlipAchievement()">
            ü™ô Share Lucky Moment
          </button>
        </div>
      </div>

              <!-- Slots Tab -->
      <div id="slots" class="tab-content">
        <h3>üé∞ Dog Slots</h3>
        <p style="margin-bottom: 20px;">Match 4 same dogs or bones to win 5000 XP!</p>
        
        <div class="slots-machine">
          <div class="slots-display">
            <div class="slot-reel" id="reel1">üêï</div>
            <div class="slot-reel" id="reel2">ü¶Æ</div>
            <div class="slot-reel" id="reel3">üê∂</div>
            <div class="slot-reel" id="reel4">ü¶¥</div>
          </div>
          
          <div class="slots-info">
            <div class="cost-info">
              <span style="color: #f59e0b;" class="cost-info">üí∞ Pay: 0.1 MONAD = 2 Credits</span>
            </div>
            <div class="prize-info">
              <span style="color: #10b981;">üèÜ 4 Match = 5000 XP</span>
            </div>
          </div>
          
          <button class="slots-button" id="slotsButton" onclick="playSlots()">
            üîí Connect Wallet
          </button>
          
          <div id="slots-status" class="status"></div>
        </div>
        
        <div class="slots-legend">
          <h4 style="margin: 20px 0 10px 0;">How It Works:</h4>
          <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: left;">
            <p style="margin-bottom: 8px;">üí∞ <strong>Pay 0.1 MONAD</strong> ‚Üí Get 2 game credits</p>
            <p style="margin-bottom: 8px;">üéÆ <strong>Each game</strong> ‚Üí Uses 1 credit</p>
            <p style="margin-bottom: 8px;">‚úÖ <strong>Credits awarded</strong> ‚Üí Only after TX confirms</p>
            <p>üé∞ <strong>Play anytime</strong> ‚Üí Use your available credits</p>
          </div>
          
          <h4 style="margin: 20px 0 10px 0;">Symbols & Prizes:</h4>
          <div class="symbol-grid">
            <div class="symbol-item">
              <span class="symbol">üêï</span>
              <span class="symbol-name">Shiba</span>
            </div>
            <div class="symbol-item">
              <span class="symbol">ü¶Æ</span>
              <span class="symbol-name">Guide Dog</span>
            </div>
            <div class="symbol-item">
              <span class="symbol">üê∂</span>
              <span class="symbol-name">Puppy</span>
            </div>
            <div class="symbol-item">
              <span class="symbol">ü¶¥</span>
              <span class="symbol-name">Bone</span>
            </div>
          </div>
          
          <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-top: 15px; text-align: left;">
            <p style="margin-bottom: 5px;">üéâ <strong>4 Same:</strong> 5000 XP (JACKPOT!)</p>
            <p style="margin-bottom: 5px;">üèÜ <strong>3 Same:</strong> 500 XP</p>
            <p>‚ú® <strong>2 Same:</strong> 50 XP</p>
          </div>
        </div>
        
        <div class="share-section">
          <button class="share-button" onclick="shareSlotsAchievement()">
            üé∞ Share Slots Win
          </button>
        </div>
      </div>

      <!-- Lucky Number Tab (Base Network Only) -->
      <div id="lucky" class="tab-content">
        <h3>üçÄ Lucky Number</h3>
        <p>Choose a number between 1-10 and earn XP if you win!</p>
        
        <div class="game-section">
          <div class="number-buttons">
            <h4>Choose Your Lucky Number:</h4>
            <div class="number-grid">
              <button class="number-btn" onclick="selectLuckyNumber(1)">1</button>
              <button class="number-btn" onclick="selectLuckyNumber(2)">2</button>
              <button class="number-btn" onclick="selectLuckyNumber(3)">3</button>
              <button class="number-btn" onclick="selectLuckyNumber(4)">4</button>
              <button class="number-btn" onclick="selectLuckyNumber(5)">5</button>
              <button class="number-btn" onclick="selectLuckyNumber(6)">6</button>
              <button class="number-btn" onclick="selectLuckyNumber(7)">7</button>
              <button class="number-btn" onclick="selectLuckyNumber(8)">8</button>
              <button class="number-btn" onclick="selectLuckyNumber(9)">9</button>
              <button class="number-btn" onclick="selectLuckyNumber(10)">10</button>
            </div>
          </div>
          
          <div id="selected-number" style="display: none; margin: 20px 0;">
            <div class="selected-info">
              <span>Selected: </span>
              <span id="selected-number-value" class="selected-value">-</span>
            </div>
          </div>
          
          <button id="luckyButton" onclick="playLuckyNumber()" disabled>
            üçÄ Play Lucky Number
          </button>
          
          <div id="lucky-status" class="status"></div>
          
          <div class="game-info">
            <div class="info-item">
              <span class="label">Win XP:</span>
              <span class="value">200 XP</span>
            </div>
            <div class="info-item">
              <span class="label">Lose XP:</span>
              <span class="value">100 XP</span>
            </div>
          </div>
        </div>
        
        <div class="achievement-section">
          <h4>üéØ How to Play</h4>
          <div class="reward-list">
            <div class="reward-item">üéØ Choose a number 1-10</div>
            <div class="reward-item">üéØ Win: Get 200 XP</div>
            <div class="reward-item">üéØ Lose: Get 100 XP</div>
          </div>
        </div>
      </div>

      <!-- Token Deploy Tab (Base Network Only) -->
      <div id="deploy" class="tab-content">
        <h3>üöÄ Deploy Token</h3>
        <p>Create your own ERC20 token on Base network!</p>
        
        <div class="game-section">
          <div class="token-form">
            <div class="form-group">
              <label for="tokenName">Token Name:</label>
              <input type="text" id="tokenName" placeholder="My Awesome Token" maxlength="20">
            </div>
            
            <div class="form-group">
              <label for="tokenSymbol">Token Symbol:</label>
              <input type="text" id="tokenSymbol" placeholder="MAT" maxlength="10">
            </div>
            
            <div class="form-group">
              <label for="initialSupply">Initial Supply:</label>
              <input type="number" id="initialSupply" placeholder="1000000" min="1">
            </div>
            
            <button id="deployButton" onclick="deployToken()" class="game-button">
              üöÄ Deploy Token
            </button>
            
            <button id="shareDeployFeature" onclick="shareDeployFeature()" class="game-button" style="margin-top: 10px; background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%);">
              üì¢ Share Deploy Feature (+50 XP)
            </button>
          </div>
          
          <div id="deploy-status" class="status"></div>
          
          <div class="game-info">
            <div class="info-item">
              <span class="label">Deploy Fee:</span>
              <span class="value" id="deploy-fee">0.0001 ETH</span>
            </div>
             <div class="info-item">
               <span class="label">XP Reward:</span>
               <span class="value">250 XP</span>
             </div>
          </div>
        </div>
        
        <div class="achievement-section">
          <h4>üéØ How to Deploy</h4>
          <div class="reward-list">
            <div class="reward-item">üöÄ Enter token name and symbol</div>
            <div class="reward-item">üöÄ Set initial supply amount</div>
            <div class="reward-item">üöÄ Pay 0.0001 ETH fee</div>
             <div class="reward-item">üöÄ Get 250 XP + your token!</div>
          </div>
        </div>
      </div>

      <!-- Claim Tab -->
      <div id="claim" class="tab-content">
        <h3>Claim $DOG Tokens</h3>
        <p style="margin-bottom: 20px;">Convert your earned XP to $DOG tokens!</p>
        <div id="claim-network-warning" style="display: none; background: rgba(99, 102, 241, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(99, 102, 241, 0.3);">
          <h4 style="color: #007bff; margin-bottom: 10px;">üîÑ Cross-Network Claiming</h4>
          <p style="color: #007bff; font-size: 14px;">You can earn XP on Base and claim $DOG tokens on Monad Testnet!</p>
        </div>
        
        <div class="claim-section">
          <div class="claim-info">
            <div class="claim-info-item">
              <div class="claim-info-label">Available XP</div>
              <div class="claim-info-value" id="claimableXP">0</div>
            </div>
            <div class="claim-info-item">
              <div class="claim-info-label">‚Üí</div>
              <div style="font-size: 30px;">üîÑ</div>
            </div>
            <div class="claim-info-item">
              <div class="claim-info-label">$DOG Tokens</div>
              <div class="claim-info-value" id="claimableDOG">0</div>
            </div>
          </div>
          
          <button class="claim-button" id="claimButton" onclick="claimTokens()" disabled>
            üí∞ Claim $DOG Tokens
          </button>
          
          <div class="conversion-rate">
            Conversion Rate: 10 XP = 1 $DOG Token
          </div>
          
          <div id="claim-status" class="status"></div>
        </div>
        
        <!-- Token Info -->
        <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px;">
          <div style="text-align: center; margin-bottom: 15px;">
            <h4 style="margin-bottom: 10px;">üêï $DOG Token Info</h4>
            <p style="font-size: 12px; opacity: 0.7;">Claim your tokens and they'll be minted directly to your wallet</p>
          </div>
          
          <!-- Wallet DOG Balance Display -->
          <div style="background: linear-gradient(135deg, #f59e0b, #eab308); padding: 20px; border-radius: 12px; text-align: center; margin: 15px 0;">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Your Wallet Balance</div>
            <div style="font-size: 32px; font-weight: 700;">
              <span id="walletDogDisplay">0</span> $DOG
            </div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;" class="network-text">ü™ô Monad Testnet</div>
          </div>
          
          <div style="margin-top: 15px; text-align: center;">
            <a href="https://testnet.monadscan.com/address/0x1f6649d028c4c146c050a9b224115a01c92a02f3" 
               target="_blank" 
               class="share-button" 
               style="background: rgba(255,255,255,0.1); font-size: 12px; padding: 8px 16px;">
              üîç View Token Contract
            </a>
          </div>
        </div>
      </div>
    </div>

    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <div class="loading-logo">
        <div class="logo-icon">Tx</div>
      </div>
      <div class="loading-text">Loading Tx App...</div>
      <div class="loading-subtitle">Starting Tx App...<br>üöÄ Initializing blockchain connection</div>
      <div class="loading-progress">
        <div class="loading-progress-bar" id="loadingProgressBar"></div>
      </div>
    </div>

    <!-- Achievement Modal -->
    <div id="achievementModal" class="achievement-modal" onclick="if(event.target === this) closeAchievementModal()">
      <div class="achievement-content">
        <button class="close-modal" onclick="closeAchievementModal()">√ó</button>
        <div id="achievementIcon" class="achievement-icon">üéâ</div>
        <h3 id="achievementTitle">Achievement Unlocked!</h3>
        <p id="achievementDescription">You did something awesome!</p>
        <div style="margin-top: 20px;">
          <button class="share-button" onclick="shareCurrentAchievement()">
            üì¢ Share on Farcaster
          </button>
          <button class="share-button" onclick="closeAchievementModal()" style="background: rgba(255,255,255,0.2);">
            ‚ú® Continue Playing
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize app
    window.addEventListener('DOMContentLoaded', function() {
      // XP stored in localStorage only (no Supabase)
    
      // Initialize modal close functions globally
      window.closeAchievementModal = function() {
        const modal = document.getElementById('achievementModal');
        if (modal) {
          modal.style.display = 'none';
        }
        window.currentAchievement = null;
        
        // Remove escape key listener
        if (window.achievementEscapeHandler) {
          document.removeEventListener('keydown', window.achievementEscapeHandler);
        }
        
        console.log('Modal closed');
      }
      
      window.shareCurrentAchievement = function() {
        if (window.currentAchievement) {
          try {
            const content = generateShareableContent(window.currentAchievement.type, window.currentAchievement.data);
            shareOnFarcaster(content);
            
            // Close modal after sharing
            setTimeout(() => {
              closeAchievementModal();
            }, 500);
          } catch (error) {
            console.error('Error sharing achievement:', error);
            closeAchievementModal();
          }
        }
      }
      
      console.log('üöÄ Starting app...');

    // Enhanced Loading Management
    let loadingProgress = 0;
    let isAppReady = false;
    let activeTab = 'pet';

    function updateLoadingProgress(progress, message) {
      const progressBar = document.getElementById('loadingProgressBar');
      const subtitle = document.querySelector('.loading-subtitle');
      
      if (progressBar) {
        progressBar.style.width = `${progress}%`;
      }
      
      if (subtitle && message) {
        subtitle.innerHTML = message;
      }
      
      loadingProgress = progress;
      console.log(`üìä Loading progress: ${progress}% - ${message}`);
    }

    function showLoadingState() {
      document.getElementById('loading').style.display = 'flex';
      document.querySelector('.app-content').classList.remove('loaded');
      updateLoadingProgress(0, 'Starting Tx App...<br>üöÄ Initializing blockchain connection');
    }

    function hideLoadingState() {
      // Don't hide immediately - show completion
      updateLoadingProgress(100, 'Ready to play! üéâ<br>Welcome to Tx App!');
      
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
        document.querySelector('.app-content').classList.add('loaded');
        isAppReady = true;
        
        // Call Farcaster ready action
        if (sdk && sdk.actions && sdk.actions.ready) {
          sdk.actions.ready({
            disableNativeGestures: false // Allow native gestures for better UX
          }).then(() => {
            console.log('‚úÖ Farcaster SDK ready called successfully');
          }).catch(error => {
            console.log('‚ö†Ô∏è Farcaster SDK ready failed:', error);
          });
        }
        
        console.log('üéâ App fully loaded and ready');
      }, 500);
    }

    // Network configuration - Base Mainnet only
    const NETWORK = {
      name: 'Base Mainnet',
      chainId: '0x2105', // 8453 in hex
      rpcUrl: 'https://mainnet.base.org',
      blockExplorer: 'https://basescan.org/',
      nativeCurrency: {
        name: 'Ethereum',
        symbol: 'ETH',
        decimals: 18
      },
      contracts: {
        // Base Mainnet deployed contracts
        PET: "0xc68d020bf3D8cb4Af48883201fFDD276ce7D5440", // ‚úÖ PetTheDog deployed
        GREET: "0x809f326b94A780e1C3d41424C208f956baE01A3d", // ‚úÖ Greet deployed
        FLIP: "0xb7a0C3fbfD48CAE8aaA737A2a6F42fdF1e243fd4", // ‚úÖ Flip deployed
        SLOTS: "0xc7660623d5038ffd511575A4b964d0aB89010f3C", // ‚úÖ Slots deployed
        LUCKY: "0xF42c81785bDa7694F51Aa1eb35c54BbdC43aF026" // ‚úÖ Lucky Number deployed
      }
    };

    // Contract addresses and ABIs
    const CONTRACTS = NETWORK.contracts;

    const ABIS = {
      PET: ["function pet() public payable"],
      GREET: ["function gm() public payable", "function gn() public payable"],
      FLIP: ["function flip() public payable"],
      SLOTS: [
        "function buyCredits() external payable",
        "function playSlots() external payable returns (uint8[4])",
        "function getCredits(address player) external view returns (uint256)",
        "function getGameStats() external view returns (uint256, uint256, uint256)",
        "event CreditsPurchased(address indexed player, uint256 credits, uint256 cost)",
        "event GamePlayed(address indexed player, uint8[4] results, uint256 creditsRemaining)",
        "event Jackpot(address indexed player, uint8 symbol, uint256 prize)"
      ],
      LUCKY: [
        "function playLuckyNumber(uint256 guess) external payable returns (uint256 luckyNumber, uint256 xpEarned, bool isWin)",
        "function getPlayerStats(address player) external view returns (uint256 games, uint256 wins, uint256 winRate)",
        "function getGameStats() external view returns (uint256 totalGames, uint256 totalFees, uint256 contractBalance)",
        "event GamePlayed(address indexed player, uint256 guess, uint256 luckyNumber, uint256 xpEarned, bool isWin)",
        "event FeeCollected(address indexed owner, uint256 amount)"
      ],
      DOG_TOKEN: [
        "function claim(uint256 xpAmount) public",
        "function balanceOf(address account) public view returns (uint256)",
        "function decimals() public view returns (uint8)",
        "function symbol() public view returns (string)",
        "function totalSupply() public view returns (uint256)",
        "function getClaimedXP(address user) public view returns (uint256)",
        "function totalMinted() public view returns (uint256)",
        "event TokensClaimed(address indexed user, uint256 xpAmount, uint256 tokenAmount)"
      ]
    };

    // XP to DOG token conversion rate
    const XP_TO_DOG_RATE = 10; // 10 XP = 1 DOG token

    // Global state 
    let appState = {
      connected: false,
      address: null,
      xp: 0, // Available XP (can be used for claiming)
      slotsCredits: 0, // Available slots game credits
      provider: null,
      signer: null,
      isTransactionPending: false,
      currentNetwork: 'base' // Base Mainnet only
    };

    // Initialize SDK
    let sdk = null;
    
    // XP Management Functions - localStorage only (persistent, never deleted)
    async function getWalletXP(address) {
      if (!address) return 0;
      
      try {
        // Get XP from Base Mainnet only (localStorage)
        const baseKey = `${address.toLowerCase()}_base`;
        const baseXP = parseInt(localStorage.getItem(`wallet_xp_${baseKey}`) || '0');
        console.log(`üìä Total XP (localStorage): Base=${baseXP}, Total=${baseXP}`);
        return baseXP;
      } catch (e) {
        console.error('Error fetching XP:', e);
        // Fallback to 0 if error
        return 0;
      }
    }

    async function saveWalletXP(address, xp) {
      if (!address) return;
      
      const networkKey = `${address.toLowerCase()}_base`;
      
      // Save to localStorage only (persistent, never deleted)
      localStorage.setItem(`wallet_xp_${networkKey}`, xp.toString());
      console.log(`üíæ XP saved to localStorage for ${networkKey}: ${xp}`);
    }

    // ‚úÖ SLOTS CREDITS MANAGEMENT - Updated with real contract integration
    async function getSlotsCredits(address) {
      if (!address || !appState.provider) return 0;
      
      try {
        // Get credits from smart contract
        const slotsContract = new ethers.Contract(
          CONTRACTS.SLOTS,
          ABIS.SLOTS,
          appState.provider
        );
        
        const credits = await slotsContract.getCredits(address);
        return credits.toNumber();
      } catch (e) {
        console.error('Error fetching slots credits from contract:', e);
        // Fallback to localStorage
        const networkKey = `${address.toLowerCase()}_base`;
        return parseInt(localStorage.getItem(`slots_credits_${networkKey}`) || '0');
      }
    }

    async function saveSlotsCredits(address, credits) {
      if (!address) return;
      
      const networkKey = `${address.toLowerCase()}_base`;
      
      // Save to localStorage for immediate display
      localStorage.setItem(`slots_credits_${networkKey}`, credits.toString());
      
      // Note: Actual credits are managed by smart contract
      // This is just for UI consistency
    }

    async function updateSlotsCreditsDisplay() {
      if (appState.connected && appState.address) {
        const credits = await getSlotsCredits(appState.address);
        appState.slotsCredits = credits;
        
        // Update slots button text
        updateSlotsButton();
        
        console.log(`üé∞ Slots Credits - Available: ${credits}`);
      } else {
        appState.slotsCredits = 0;
        updateSlotsButton();
      }
    }

    function updateSlotsButton() {
      const slotsButton = document.getElementById('slotsButton');
      if (!slotsButton) return;
      
      if (appState.slotsCredits > 0) {
        slotsButton.textContent = `üé∞ Play Slots (${appState.slotsCredits} credits)`;
        slotsButton.disabled = false;
      } else if (appState.connected) {
        slotsButton.textContent = `üé∞ Play Slots`;
        slotsButton.disabled = false;
      } else {
        slotsButton.textContent = `üîí Connect Wallet`;
        slotsButton.disabled = true;
      }
    }

    async function updateXPDisplay() {
      if (appState.connected && appState.address) {
        // Show current value immediately
        const currentDisplay = document.getElementById('xp').textContent;
        
        // Get XP (with timeout to prevent hanging)
        const xpPromise = getWalletXP(appState.address);
        const timeoutPromise = new Promise((resolve) => setTimeout(() => resolve(parseInt(currentDisplay) || 0), 1000));
        
        const walletXP = await Promise.race([xpPromise, timeoutPromise]);
        
        document.getElementById('xp').textContent = walletXP;
        appState.xp = walletXP;
        
        // Also update slots credits
        await updateSlotsCreditsDisplay();
        
        console.log(`üìä XP Display - Available: ${walletXP}`);
        
        // Update claim UI non-blocking
        if (activeTab === 'claim') {
          requestAnimationFrame(() => updateClaimUI());
        }
      } else {
        document.getElementById('xp').textContent = '0';
        appState.xp = 0;
        appState.slotsCredits = 0;
        updateClaimUI();
        updateSlotsButton();
      }
    }

    // Update claim UI based on current XP
    async function updateClaimUI() {
      const claimableXP = appState.xp || 0;
      const claimableDOG = Math.floor(claimableXP / XP_TO_DOG_RATE);
      
      document.getElementById('claimableXP').textContent = claimableXP;
      document.getElementById('claimableDOG').textContent = claimableDOG;
      
      const claimButton = document.getElementById('claimButton');
      
      // Claim feature removed - Base Mainnet only
      claimButton.disabled = true;
      claimButton.textContent = 'üöÄ Claim feature coming soon!';
    }

    // Update token balance display
    async function updateTokenBalance() {
      if (!appState.connected || !appState.provider || !appState.address) {
        console.log('‚ùå Not connected, cannot fetch balance');
        document.getElementById('walletDogDisplay').textContent = '0';
        return;
      }
      
      // Token balance feature removed - Base Mainnet only
      console.log('‚ùå Token balance feature not available on Base Mainnet');
      if (document.getElementById('walletDogDisplay')) {
        document.getElementById('walletDogDisplay').textContent = '0';
      }
      return;
      
      console.log('üîÑ Fetching DOG balance for:', appState.address);
      
      try {
        // Check if we're using Farcaster wallet
        const isFarcasterWallet = sdk && sdk.wallet && sdk.wallet.ethProvider;
        
        if (isFarcasterWallet) {
          console.log('üü£ Using Farcaster wallet - trying direct RPC call');
          
          try {
            // Encode the balanceOf function call
            const iface = new ethers.utils.Interface([
              "function balanceOf(address account) public view returns (uint256)"
            ]);
            const data = iface.encodeFunctionData("balanceOf", [appState.address]);
            
            // Make the call using the provider's send method
            const result = await appState.provider.send("eth_call", [{
              to: CONTRACTS.DOG_TOKEN,
              data: data
            }, "latest"]);
            
            console.log('Raw result:', result);
            
            if (result && result !== '0x') {
              const balance = ethers.BigNumber.from(result);
              const formattedBalance = ethers.utils.formatUnits(balance, 18);
              const numBalance = parseFloat(formattedBalance);
              const displayBalance = numBalance >= 1 ? numBalance.toFixed(2) : 
                                   numBalance > 0 ? numBalance.toFixed(6) : '0';
              
              document.getElementById('walletDogDisplay').textContent = displayBalance;
              console.log(`‚úÖ DOG Balance (Farcaster): ${displayBalance}`);
            } else {
              console.log('No balance or contract not found');
              document.getElementById('walletDogDisplay').textContent = '0';
            }
            
          } catch (callError) {
            console.error('Direct eth_call failed:', callError);
            
            // Fallback: Try using a public RPC endpoint
            console.log('Trying fallback RPC...');
            try {
              const fallbackProvider = new ethers.providers.JsonRpcProvider('https://testnet-rpc.monad.xyz');
              const dogTokenContract = new ethers.Contract(
                CONTRACTS.DOG_TOKEN,
                ["function balanceOf(address) view returns (uint256)"],
                fallbackProvider
              );
              
              const balance = await dogTokenContract.balanceOf(appState.address);
              const formattedBalance = ethers.utils.formatUnits(balance, 18);
              const numBalance = parseFloat(formattedBalance);
              const displayBalance = numBalance >= 1 ? numBalance.toFixed(2) : 
                                   numBalance > 0 ? numBalance.toFixed(6) : '0';
              
              document.getElementById('walletDogDisplay').textContent = displayBalance;
              console.log(`‚úÖ DOG Balance (Fallback RPC): ${displayBalance}`);
              
            } catch (fallbackError) {
              console.error('Fallback RPC also failed:', fallbackError);
              document.getElementById('walletDogDisplay').textContent = '0';
            }
          }
          
        } else {
          // Regular wallet (MetaMask, etc.)
          console.log('ü¶ä Using regular wallet provider');
          
          const dogTokenContract = new ethers.Contract(
            CONTRACTS.DOG_TOKEN,
            ["function balanceOf(address) view returns (uint256)"],
            appState.provider
          );
          
          const balance = await dogTokenContract.balanceOf(appState.address);
          const formattedBalance = ethers.utils.formatUnits(balance, 18);
          const numBalance = parseFloat(formattedBalance);
          const displayBalance = numBalance >= 1 ? numBalance.toFixed(2) : 
                               numBalance > 0 ? numBalance.toFixed(6) : '0';
          
          document.getElementById('walletDogDisplay').textContent = displayBalance;
          console.log(`‚úÖ DOG Balance: ${displayBalance}`);
        }
        
      } catch (error) {
        console.error('‚ùå Error fetching token balance:', error);
        
        // Last resort: Use localStorage cache if available
        const networkKey = `${appState.address.toLowerCase()}_base`;
        const cachedBalance = localStorage.getItem(`dog_balance_${networkKey}`);
        if (cachedBalance) {
          document.getElementById('walletDogDisplay').textContent = cachedBalance;
          console.log(`üì¶ Using cached balance: ${cachedBalance}`);
        } else {
          document.getElementById('walletDogDisplay').textContent = '0';
        }
      }
    }

    // ‚úÖ FIXED CLAIM FUNCTION - XP resets after user confirms transaction + Button cooldown
    window.claimTokens = async function() {
      if (!appState.connected || !appState.signer) {
        showError('Please connect your wallet first');
        return;
      }
      
      // DOG token contract check removed - Base network claim is blocked, Monad has contract
      
      const availableXP = appState.xp;
      const claimableDOG = Math.floor(availableXP / XP_TO_DOG_RATE);
      
      if (availableXP < XP_TO_DOG_RATE) {
        showError(`Need at least ${XP_TO_DOG_RATE} XP to claim tokens`);
        return;
      }
      
      const claimButton = document.getElementById('claimButton');
      
      try {
        console.log('üí∞ Starting token claim...');
        
        // ‚úÖ Disable button immediately for 30 seconds
        claimButton.disabled = true;
        
        // Start countdown
        let countdown = 30;
        const originalText = claimButton.textContent;
        
        const countdownInterval = setInterval(() => {
          countdown--;
          claimButton.textContent = `‚è≥ Please wait ${countdown}s...`;
          
          if (countdown <= 0) {
            clearInterval(countdownInterval);
            // Re-enable button and update text after countdown
            updateClaimUI();
          }
        }, 1000);
        
        showStatus('claim-status', 'üîê Please confirm transaction in your wallet...', 'pending');
        
        // Ensure correct network
        await ensureCorrectNetwork();
        
        // Call the actual DOG token contract
        const dogTokenContract = new ethers.Contract(
          CONTRACTS.DOG_TOKEN,
          ABIS.DOG_TOKEN,
          appState.signer
        );
        
        // Calculate XP to claim (must be multiple of 10)
        const xpToClaim = claimableDOG * XP_TO_DOG_RATE;
        
        console.log(`Claiming ${xpToClaim} XP for ${claimableDOG} DOG tokens`);
        
        // Execute claim transaction with proper gas limit
        const tx = await dogTokenContract.claim(xpToClaim, {
          gasLimit: 100000
        });
        
        // ‚úÖ USER CONFIRMED TRANSACTION - NOW RESET XP IMMEDIATELY
        console.log('üéØ Transaction confirmed by user - resetting XP to 0');
        
        // Reset XP to 0 in state and display immediately
        appState.xp = 0;
        document.getElementById('xp').textContent = '0';
        
        // ‚úÖ Save XP as 0 to BOTH networks immediately
        const baseKey = `${appState.address.toLowerCase()}_base`;
        
        // Reset Base XP (localStorage only)
        localStorage.setItem(`wallet_xp_${baseKey}`, '0');
        console.log('üíæ XP reset in localStorage (Base Mainnet)');
        
        // Update claim UI immediately
        await updateClaimUI();
        
        showStatus('claim-status', `üì° Transaction sent: ${tx.hash.slice(0,10)}... XP reset to 0`, 'pending');
        console.log('Transaction hash:', tx.hash);
        console.log('‚úÖ XP successfully reset to 0 - user can continue earning');
        
        // Wait for confirmation and update balance
        setTimeout(async () => {
          try {
            // Try to get updated balance with multiple retries
            const updateBalanceWithRetry = async (retries = 3) => {
              for (let i = 0; i < retries; i++) {
                try {
                  await new Promise(resolve => setTimeout(resolve, 2000 * (i + 1)));
                  
                  const newBalance = await dogTokenContract.balanceOf(appState.address);
                  const decimals = await dogTokenContract.decimals();
                  const formattedBalance = ethers.utils.formatUnits(newBalance, decimals);
                  
                  const numBalance = parseFloat(formattedBalance);
                  const displayBalance = numBalance >= 1 ? numBalance.toFixed(2) : numBalance.toFixed(6);
                  
                  document.getElementById('walletDogDisplay').textContent = displayBalance;
                  
        // Cache the balance
        const networkKey = `${appState.address.toLowerCase()}_base`;
        localStorage.setItem(`dog_balance_${networkKey}`, displayBalance);
                  
                  console.log(`‚úÖ Balance updated after claim (attempt ${i + 1}): ${displayBalance} DOG`);
                  break;
                } catch (e) {
                  console.log(`Balance update attempt ${i + 1} failed, retrying...`);
                }
              }
            };
            
            updateBalanceWithRetry();
            
            showStatus('claim-status', `‚úÖ Successfully claimed ${claimableDOG} $DOG tokens! XP reset - start earning again!`, 'success');
            
            // Show achievement
            showAchievementModal({
              icon: 'üí∞',
              title: 'Tokens Claimed!',
              description: `You've successfully claimed ${claimableDOG} $DOG tokens! Your XP has been reset - start earning again!`,
              type: 'claim',
              data: { amount: claimableDOG }
            });
            
            setTimeout(() => hideStatus('claim-status'), 8000);
            
          } catch (e) {
            console.log('Post-claim update error:', e);
            showStatus('claim-status', `‚úÖ Claim transaction sent! Tokens will arrive soon. XP reset successfully.`, 'success');
            setTimeout(() => hideStatus('claim-status'), 8000);
          }
        }, 5000);
        
      } catch (error) {
        console.error('‚ùå Claim error:', error);
        
        let errorMsg = 'Failed to claim tokens';
        
        if (error.message.includes('user rejected')) {
          errorMsg = 'Transaction cancelled - XP not affected';
          // Don't reset XP if user cancelled
          console.log('üö´ Transaction cancelled - XP remains unchanged');
        } else if (error.message.includes('insufficient funds')) {
          errorMsg = 'Insufficient gas funds';
        } else if (error.message.includes('XP already claimed')) {
          errorMsg = 'This XP has already been claimed';
          // Reset XP if already claimed on contract
          appState.xp = 0;
          await saveWalletXP(appState.address, 0);
          await updateXPDisplay();
        } else if (error.message.includes('Invalid XP amount')) {
          errorMsg = 'Invalid XP amount. Must be multiple of 10';
        }
        
        showStatus('claim-status', errorMsg, 'error');
        setTimeout(() => hideStatus('claim-status'), 5000);
      }
    };

    async function initializeAppWithProgress() {
      try {
        showLoadingState();
        
        // Step 1: Initialize SDK
        updateLoadingProgress(20, 'Loading Farcaster SDK...<br>üîó Connecting to Frame environment');
        
        try {
          const module = await import('https://esm.sh/@farcaster/frame-sdk');
          sdk = module.sdk;
          console.log('SDK loaded:', !!sdk);
          
          if (sdk) {
            updateLoadingProgress(40, 'Farcaster SDK loaded! ‚úÖ<br>üì± Setting up Mini App environment');
            await sdk.actions.ready();
            console.log('SDK ready');
          }
        } catch (e) {
          console.log('SDK not available:', e.message);
          updateLoadingProgress(40, 'Running in standalone mode<br>üåê Browser environment detected');
        }

        // Step 2: Setup game functions
        updateLoadingProgress(60, 'Setting up game functions...<br>üéÆ Preparing blockchain interactions');
        await new Promise(resolve => setTimeout(resolve, 300));
        
        setupEventListeners();
        setupGameFunctions();
        
        // Step 3: Initialize app
        updateLoadingProgress(80, 'Initializing app...<br>üéÆ Setting up game');
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // Step 4: Finalize
        updateLoadingProgress(95, 'Almost ready...<br>‚ú® Final preparations');
        await new Promise(resolve => setTimeout(resolve, 200));
        
        hideLoadingState();
        console.log('‚úÖ App initialized successfully with progress tracking');
        
      } catch (error) {
        console.error('‚ùå Init error:', error);
        updateLoadingProgress(100, 'Error occurred, but app will continue<br>‚ö†Ô∏è Some features may be limited');
        
        setTimeout(() => {
          hideLoadingState();
        }, 1000);
      }
    }

    async function initApp() {
      await initializeAppWithProgress();
    }

    function setupEventListeners() {
      document.getElementById('connect-btn').onclick = connectWallet;
      document.getElementById('disconnect-btn').onclick = disconnect;
    }

    // Network switching function
    // Update network display in UI (Base Mainnet only)
    function updateNetworkDisplay() {
      // Update token balance display
      const tokenDisplay = document.querySelector('.token-balance');
      if (tokenDisplay) {
        const networkText = tokenDisplay.querySelector('.network-text');
        if (networkText) {
          networkText.textContent = `ü™ô ${NETWORK.name}`;
        }
      }
      
      // Update XP display
      const xpDisplay = document.getElementById('xp-display');
      if (xpDisplay) {
        xpDisplay.innerHTML = 'üéÆ Game Score: <span id="xp">0</span>';
      }
      
      // Update slots cost display
      const slotsCost = document.querySelector('.cost-info span');
      if (slotsCost) {
        slotsCost.textContent = 'üé∞ Play Slots - Direct Game';
      }
    }

    // Disable all action buttons during transaction
    function disableAllActionButtons() {
      const buttons = [
        ...document.querySelectorAll('#pet button'),
        ...document.querySelectorAll('#greet button'),
        ...document.querySelectorAll('#flip button'),
        document.getElementById('claimButton')
      ];
      
      buttons.forEach(button => {
        if (button && !button.id.includes('disconnect') && !button.classList.contains('tab') && !button.classList.contains('share-button')) {
          button.disabled = true;
          button.dataset.originalText = button.textContent;
        }
      });
      
      appState.isTransactionPending = true;
    }

    // Enable all action buttons after transaction
    function enableAllActionButtons() {
      const buttons = [
        ...document.querySelectorAll('#pet button'),
        ...document.querySelectorAll('#greet button'),
        ...document.querySelectorAll('#flip button'),
        document.getElementById('claimButton')
      ];
      
      buttons.forEach(button => {
        if (button && !button.id.includes('disconnect') && !button.classList.contains('tab') && !button.classList.contains('share-button')) {
          button.disabled = false;
          if (button.dataset.originalText) {
            button.textContent = button.dataset.originalText;
            delete button.dataset.originalText;
          }
        }
      });
      
      appState.isTransactionPending = false;
      
      // Update claim button state
      if (activeTab === 'claim') {
        updateClaimUI();
      }
    }

    function setupGameFunctions() {
      // Define all game functions globally
      window.petDog = async function() {
        console.log('üêï Pet Dog clicked!');
        
        if (!appState.connected) {
          console.log('‚ùå Wallet not connected');
          showError('Connect wallet first');
          return;
        }
        
        if (appState.isTransactionPending) {
          showError('Please wait for the current transaction to complete');
          return;
        }
        
        console.log('‚úÖ Wallet connected, starting pet transaction');
        
        // Change dog image
        document.getElementById('dog-img').src = `https://placedog.net/400/300?id=${Math.floor(Math.random() * 50) + 1}`;
        
        // Execute real blockchain transaction
        await executeTransaction(
          CONTRACTS.PET,
          ABIS.PET,
          'pet',
          'pet-status',
          'üêï Dog petted successfully! +10 XP',
          10
        );
      };

      window.sayGM = async function() {
        console.log('‚òÄÔ∏è Say GM clicked!');
        
        if (!appState.connected) {
          showError('Connect wallet first');
          return;
        }
        
        if (appState.isTransactionPending) {
          showError('Please wait for the current transaction to complete');
          return;
        }
        
        await executeTransaction(
          CONTRACTS.GREET,
          ABIS.GREET,
          'gm',
          'greet-status',
          '‚òÄÔ∏è Good Morning sent! +5 XP',
          5
        );
      };

      window.sayGN = async function() {
        console.log('üåô Say GN clicked!');
        
        if (!appState.connected) {
          showError('Connect wallet first');
          return;
        }
        
        if (appState.isTransactionPending) {
          showError('Please wait for the current transaction to complete');
          return;
        }
        
        await executeTransaction(
          CONTRACTS.GREET,
          ABIS.GREET,
          'gn',
          'greet-status',
          'üåô Good Night sent! +5 XP',
          5
        );
      };

      window.flipCoin = async function() {
        console.log('ü™ô Flip Coin clicked!');
        
        if (!appState.connected) {
          showError('Connect wallet first');
          return;
        }
        
        if (appState.isTransactionPending) {
          showError('Please wait for the current transaction to complete');
          return;
        }
        
        const coin = document.getElementById('coin');
        const result = document.getElementById('flip-result');
        
        // Start visual animation
        result.textContent = 'Flipping...';
        let rotation = 0;
        const interval = setInterval(() => {
          rotation += 180;
          coin.style.transform = `rotateY(${rotation}deg)`;
        }, 100);
        
        // Execute real transaction
        await executeTransaction(
          CONTRACTS.FLIP,
          ABIS.FLIP,
          'flip',
          'flip-status',
          'ü™ô Coin flipped! +3 XP',
          3
        );
        
        // Stop animation after transaction starts
        setTimeout(() => {
          clearInterval(interval);
          const finalResult = Math.random() < 0.5 ? 'Heads' : 'Tails';
          coin.style.transform = `rotateY(${finalResult === 'Heads' ? 0 : 180}deg)`;
          result.textContent = `Result: ${finalResult}!`;
        }, 3000);
      };

      // ‚úÖ SLOTS GAME FUNCTION - NETWORK-SPECIFIC
      window.playSlots = async function() {
        console.log('üé∞ Play Slots clicked!');
        
        if (!appState.connected) {
          showError('Connect wallet first');
          return;
        }
        
        if (appState.isTransactionPending) {
          showError('Please wait for the current transaction to complete');
          return;
        }
        
        const slotsButton = document.getElementById('slotsButton');
        const originalText = slotsButton.textContent;
        
        // Base Mainnet: Direct play system
        // Direct play (no credits needed)
        await playSlotGameDirect();
      };

      // Buy slot credits with payment - REAL CONTRACT VERSION
      async function buySlotCredits() {
        const slotsButton = document.getElementById('slotsButton');
        const originalText = slotsButton.textContent;
        
        // Check if slots contract is deployed
        if (CONTRACTS.SLOTS === "0x0000000000000000000000000000000000000000") {
          const networkName = NETWORK.name;
          showError(`${networkName} slots contract not deployed yet. Please deploy contracts first.`);
          return;
        }
        
        try {
          // Disable button immediately
          slotsButton.disabled = true;
          slotsButton.textContent = 'üí∞ Buying Credits...';
          
          const paymentText = '0.001 ETH';
          showStatus('slots-status', `üîê Please confirm payment of ${paymentText} for 2 game credits...`, 'pending');
          
          // Ensure correct network
          await ensureCorrectNetwork();
          
          // ‚úÖ REAL CONTRACT CALL
          const slotsContract = new ethers.Contract(CONTRACTS.SLOTS, ABIS.SLOTS, appState.signer);
          
          // Send transaction with appropriate payment amount
          const paymentAmount = "0.001"; // 0.001 ETH for Base Mainnet
          const tx = await slotsContract.buyCredits({
            value: ethers.utils.parseEther(paymentAmount),
            gasLimit: 100000
          });
          
          console.log('‚úÖ Credits purchase transaction sent:', tx.hash);
          showStatus('slots-status', `üì° Payment sent: ${tx.hash.slice(0,10)}... Waiting for confirmation...`, 'pending');
          
          // Wait for transaction confirmation
          setTimeout(async () => {
            try {
              // ‚úÖ GET CREDITS FROM CONTRACT
              const credits = await slotsContract.getCredits(appState.address);
              appState.slotsCredits = credits.toNumber();
              
              // Save to localStorage for immediate display
              await saveSlotsCredits(appState.address, appState.slotsCredits);
              updateSlotsButton();
              
              showStatus('slots-status', `‚úÖ Payment confirmed! You have ${appState.slotsCredits} game credits!`, 'success');
              console.log(`‚úÖ ${appState.slotsCredits} slots credits confirmed from contract`);
              
              setTimeout(() => hideStatus('slots-status'), 3000);
            } catch (e) {
              console.error('Error getting credits after purchase:', e);
              // Fallback: assume 2 credits were added
              appState.slotsCredits += 2;
              await saveSlotsCredits(appState.address, appState.slotsCredits);
              updateSlotsButton();
              
              showStatus('slots-status', '‚úÖ Payment confirmed! Credits should be available soon.', 'success');
              setTimeout(() => hideStatus('slots-status'), 3000);
            }
          }, 5000);
          
        } catch (error) {
          console.error('‚ùå Payment error:', error);
          
          slotsButton.disabled = false;
          slotsButton.textContent = originalText;
          
          let errorMsg = 'Payment failed';
          if (error.message.includes('user rejected')) {
            errorMsg = 'Payment cancelled';
          } else if (error.message.includes('insufficient funds')) {
            const currency = 'ETH';
            errorMsg = `Insufficient ${currency} balance`;
          }
          
          showStatus('slots-status', errorMsg, 'error');
          setTimeout(() => hideStatus('slots-status'), 5000);
        }
      }

      // Base aƒüƒ± i√ßin direkt oyun fonksiyonu
      async function playSlotGameDirect() {
        const slotsButton = document.getElementById('slotsButton');
        
        try {
          // Disable button during game
          slotsButton.disabled = true;
          slotsButton.textContent = 'üé∞ Playing...';
          
          console.log('üéÆ Playing slots directly on Base network');
          showStatus('slots-status', 'üé∞ Spinning the reels...', 'pending');
          
          // ‚úÖ REAL CONTRACT CALL - Base aƒüƒ±nda direkt oyun
          const slotsContract = new ethers.Contract(CONTRACTS.SLOTS, ABIS.SLOTS, appState.signer);
          
          // Play slots on contract (with fee automatically)
          const tx = await slotsContract.playSlots({
            value: ethers.utils.parseEther("0.00001"), // 0.00001 ETH fee
            gasLimit: 150000
          });
          
          console.log('‚úÖ Slots game transaction sent:', tx.hash);
          
          // Start visual animation while waiting for result
          const symbols = ['üêï', 'ü¶Æ', 'üê∂', 'ü¶¥'];
          const reels = ['reel1', 'reel2', 'reel3', 'reel4'];
          
          // Spinning animation
          reels.forEach(reelId => {
            const reel = document.getElementById(reelId);
            reel.classList.add('spinning');
          });
          
          let spinDuration = 4000; // 4 seconds of spinning
          
          const spinInterval = setInterval(() => {
            reels.forEach(reelId => {
              const reel = document.getElementById(reelId);
              reel.textContent = symbols[Math.floor(Math.random() * symbols.length)];
            });
          }, 100);
          
          // Wait for transaction and get results
          setTimeout(async () => {
            clearInterval(spinInterval);
            
            try {
              // Get transaction receipt to see events
              const receipt = await appState.provider.getTransactionReceipt(tx.hash);
              
              // Parse game results from events (simplified - in real implementation you'd parse the event)
              // For now, generate results based on transaction hash for deterministic results
              const results = [];
              const txHash = tx.hash;
              for (let i = 0; i < 4; i++) {
                const byte = parseInt(txHash.slice(2 + i * 2, 4 + i * 2), 16);
                results.push(symbols[byte % 4]);
              }
              
              // Display final results
              reels.forEach((reelId, index) => {
                const reel = document.getElementById(reelId);
                reel.classList.remove('spinning');
                reel.textContent = results[index];
              });
              
              console.log(`üéÆ Game completed on Base network`);
              
              // Check for winning combinations and award XP
              setTimeout(() => {
                checkSlotsWin(results);
                updateSlotsButton();
              }, 500);
              
            } catch (e) {
              console.error('Error processing game result:', e);
              
              // Fallback: Generate random results
              const results = [];
              for (let i = 0; i < 4; i++) {
                results.push(symbols[Math.floor(Math.random() * symbols.length)]);
              }
              
              reels.forEach((reelId, index) => {
                const reel = document.getElementById(reelId);
                reel.classList.remove('spinning');
                reel.textContent = results[index];
              });
              
              setTimeout(() => {
                checkSlotsWin(results);
                updateSlotsButton();
              }, 500);
            }
          }, spinDuration);
          
        } catch (error) {
          console.error('‚ùå Game error:', error);
          
          // Stop spinning animation
          const reels = ['reel1', 'reel2', 'reel3', 'reel4'];
          reels.forEach(reelId => {
            const reel = document.getElementById(reelId);
            reel.classList.remove('spinning');
          });
          
          updateSlotsButton();
          
          let errorMsg = 'Game failed';
          if (error.message.includes('user rejected')) {
            errorMsg = 'Game cancelled';
          }
          
          showStatus('slots-status', errorMsg, 'error');
          setTimeout(() => hideStatus('slots-status'), 5000);
        }
      }

      // Play the actual slot game using 1 credit - REAL CONTRACT VERSION
      async function playSlotGame() {
        if (appState.slotsCredits <= 0) {
          showError('No game credits available');
          return;
        }
        
        // Check if slots contract is deployed
        if (CONTRACTS.SLOTS === "0x0000000000000000000000000000000000000000") {
          const networkName = NETWORK.name;
          showError(`${networkName} slots contract not deployed yet. Please deploy contracts first.`);
          return;
        }
        
        const slotsButton = document.getElementById('slotsButton');
        
        try {
          // Disable button during game
          slotsButton.disabled = true;
          slotsButton.textContent = 'üé∞ Playing...';
          
          console.log(`üéÆ Playing slots with contract, current credits: ${appState.slotsCredits}`);
          showStatus('slots-status', 'üé∞ Spinning the reels...', 'pending');
          
          // ‚úÖ REAL CONTRACT CALL
          const slotsContract = new ethers.Contract(CONTRACTS.SLOTS, ABIS.SLOTS, appState.signer);
          
          // Play slots on contract (uses 1 credit automatically)
          const tx = await slotsContract.playSlots({
            gasLimit: 150000
          });
          
          console.log('‚úÖ Slots game transaction sent:', tx.hash);
          
          // Start visual animation while waiting for result
          const symbols = ['üêï', 'ü¶Æ', 'üê∂', 'ü¶¥'];
          const reels = ['reel1', 'reel2', 'reel3', 'reel4'];
          
          // Spinning animation
          reels.forEach(reelId => {
            const reel = document.getElementById(reelId);
            reel.classList.add('spinning');
          });
          
          let spinDuration = 4000; // 4 seconds of spinning
          
          const spinInterval = setInterval(() => {
            reels.forEach(reelId => {
              const reel = document.getElementById(reelId);
              reel.textContent = symbols[Math.floor(Math.random() * symbols.length)];
            });
          }, 100);
          
          // Wait for transaction and get results
          setTimeout(async () => {
            clearInterval(spinInterval);
            
            try {
              // Get transaction receipt to see events
              const receipt = await appState.provider.getTransactionReceipt(tx.hash);
              
              // Parse game results from events (simplified - in real implementation you'd parse the event)
              // For now, generate results based on transaction hash for deterministic results
              const results = [];
              const txHash = tx.hash;
              for (let i = 0; i < 4; i++) {
                const byte = parseInt(txHash.slice(2 + i * 2, 4 + i * 2), 16);
                results.push(symbols[byte % 4]);
              }
              
              // Display final results
              reels.forEach((reelId, index) => {
                const reel = document.getElementById(reelId);
                reel.classList.remove('spinning');
                reel.textContent = results[index];
              });
              
              // Update credits from contract
              const newCredits = await slotsContract.getCredits(appState.address);
              appState.slotsCredits = newCredits.toNumber();
              await saveSlotsCredits(appState.address, appState.slotsCredits);
              
              console.log(`üéÆ Game completed, remaining credits: ${appState.slotsCredits}`);
              
              // Check for winning combinations and award XP
              setTimeout(() => {
                checkSlotsWin(results);
                updateSlotsButton();
              }, 500);
              
            } catch (e) {
              console.error('Error processing game result:', e);
              
              // Fallback: Generate random results and update credits
              const results = [];
              for (let i = 0; i < 4; i++) {
                results.push(symbols[Math.floor(Math.random() * symbols.length)]);
              }
              
              reels.forEach((reelId, index) => {
                const reel = document.getElementById(reelId);
                reel.classList.remove('spinning');
                reel.textContent = results[index];
              });
              
              // Assume 1 credit was used
              appState.slotsCredits = Math.max(0, appState.slotsCredits - 1);
              await saveSlotsCredits(appState.address, appState.slotsCredits);
              
              setTimeout(() => {
                checkSlotsWin(results);
                updateSlotsButton();
              }, 500);
            }
          }, spinDuration);
          
        } catch (error) {
          console.error('‚ùå Game error:', error);
          
          // Stop spinning animation
          const reels = ['reel1', 'reel2', 'reel3', 'reel4'];
          reels.forEach(reelId => {
            const reel = document.getElementById(reelId);
            reel.classList.remove('spinning');
          });
          
          updateSlotsButton();
          
          let errorMsg = 'Game failed';
          if (error.message.includes('No credits available')) {
            errorMsg = 'No credits available';
          } else if (error.message.includes('user rejected')) {
            errorMsg = 'Game cancelled';
          }
          
          showStatus('slots-status', errorMsg, 'error');
          setTimeout(() => hideStatus('slots-status'), 5000);
        }
      }

      // Check slots winning combinations
      function checkSlotsWin(results) {
        console.log('üé∞ Slots results:', results);
        
        // Count occurrences of each symbol
        const symbolCounts = {};
        results.forEach(symbol => {
          symbolCounts[symbol] = (symbolCounts[symbol] || 0) + 1;
        });
        
        // Check for 4 of a kind (jackpot)
        const maxCount = Math.max(...Object.values(symbolCounts));
        
        if (maxCount === 4) {
          // JACKPOT! 4 of a kind
          const winningSymbol = Object.keys(symbolCounts).find(symbol => symbolCounts[symbol] === 4);
          
          // Highlight winning reels
          document.querySelectorAll('.slot-reel').forEach(reel => {
            if (reel.textContent === winningSymbol) {
              reel.classList.add('winning');
            }
          });
          
          // Award 5000 XP
          addXP(5000);
          
          showStatus('slots-status', `üéâ JACKPOT! 4x ${winningSymbol} = +5000 XP!`, 'success');
          
          // Show jackpot achievement
          setTimeout(() => {
            showAchievementModal({
              icon: 'üé∞',
              title: 'JACKPOT WINNER!',
              description: `Amazing! You got 4x ${winningSymbol} and won 5000 XP! You're incredibly lucky!`,
              type: 'slots',
              data: { 
                symbol: winningSymbol, 
                count: 4, 
                xp: 5000,
                result: results.join('')
              }
            });
          }, 1000);
          
        } else if (maxCount === 3) {
          // 3 of a kind - smaller win
          const winningSymbol = Object.keys(symbolCounts).find(symbol => symbolCounts[symbol] === 3);
          
          // Highlight winning reels
          document.querySelectorAll('.slot-reel').forEach(reel => {
            if (reel.textContent === winningSymbol) {
              reel.classList.add('winning');
            }
          });
          
          // Award 500 XP for 3 of a kind
          addXP(500);
          
          showStatus('slots-status', `üèÜ 3x ${winningSymbol} = +500 XP!`, 'success');
          
        } else if (maxCount === 2) {
          // 2 of a kind - small win
          const winningSymbol = Object.keys(symbolCounts).find(symbol => symbolCounts[symbol] === 2);
          
          // Award 50 XP for 2 of a kind
          addXP(50);
          
          showStatus('slots-status', `‚ú® 2x ${winningSymbol} = +50 XP!`, 'success');
          
        } else {
          // No win
          showStatus('slots-status', 'üòî No match this time. Try again!', 'error');
        }
        
        // Clear status and winning highlights after delay
        setTimeout(() => {
          hideStatus('slots-status');
          document.querySelectorAll('.slot-reel').forEach(reel => {
            reel.classList.remove('winning');
          });
        }, 5000);
      }

      // Reset slots display
      function resetSlotsDisplay() {
        const symbols = ['üêï', 'ü¶Æ', 'üê∂', 'ü¶¥'];
        const reels = ['reel1', 'reel2', 'reel3', 'reel4'];
        
        reels.forEach((reelId, index) => {
          const reel = document.getElementById(reelId);
          reel.textContent = symbols[index];
          reel.classList.remove('spinning', 'winning');
        });
      }

      window.showTab = function(tabName) {
        console.log('üìë Switching to tab:', tabName);
        
        // Block claim tab on Base network
        if (tabName === 'claim') {
          console.log('‚ùå Claim tab blocked on Base network');
          return;
        }
        
        // Block lucky tab on Monad network
        // Lucky tab available on Base Mainnet
        
        activeTab = tabName;
        
        // Update tabs
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Update content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(tabName).classList.add('active');
        
        // Handle claim tab based on network
        if (tabName === 'claim') {
          // Claim feature removed - Base Mainnet only
          // Claim UI removed
        }
        
        // Update slots when switching to slots tab
        if (tabName === 'slots') {
          resetSlotsDisplay();
          updateSlotsButton();
        }
      };
      
      console.log('üéÆ Game functions setup complete');
    }

    async function connectWallet() {
      try {
        console.log('Connecting wallet...');
        
        // Show loading state
        const connectBtn = document.getElementById('connect-btn');
        connectBtn.textContent = 'üîÑ Connecting...';
        connectBtn.disabled = true;
        
        let provider;
        
        if (sdk && sdk.wallet && sdk.wallet.ethProvider) {
          console.log('Using Farcaster wallet');
          provider = sdk.wallet.ethProvider;
        } else if (window.ethereum) {
          console.log('Using browser wallet');
          provider = window.ethereum;
        } else {
          throw new Error('No wallet available');
        }

        // Request accounts with timeout
        const accountsPromise = provider.request({
          method: 'eth_requestAccounts'
        });
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Connection timeout')), 10000)
        );
        
        const accounts = await Promise.race([accountsPromise, timeoutPromise]);

        if (!accounts || accounts.length === 0) {
          throw new Error('No accounts found');
        }

        console.log('‚úÖ Connected:', accounts[0]);

        // Setup ethers
        appState.provider = new ethers.providers.Web3Provider(provider);
        appState.signer = appState.provider.getSigner();
        appState.address = accounts[0];
        appState.connected = true;

        // Update UI and load wallet-specific data
        updateWalletUI();
        
        // Load data asynchronously
        updateXPDisplay().catch(console.error);
        
        // Ensure network is correct before fetching balance
        await ensureCorrectNetwork();
        
        // Update token balance with multiple retries
        const fetchBalance = async () => {
          for (let i = 0; i < 3; i++) {
            try {
              await updateTokenBalance();
              break;
            } catch (e) {
              console.log(`Balance fetch attempt ${i + 1} failed, retrying...`);
              await new Promise(resolve => setTimeout(resolve, 2000));
            }
          }
        };
        
        fetchBalance();

      } catch (error) {
        console.error('Connection error:', error);
        showError(error.message);
        
        // Reset button
        const connectBtn = document.getElementById('connect-btn');
        connectBtn.textContent = 'üü£ Connect Wallet';
        connectBtn.disabled = false;
      }
    }

    async function disconnect() {
      appState = {
        connected: false,
        address: null,
        xp: 0,
        slotsCredits: 0,
        provider: null,
        signer: null,
        currentNetwork: 'base'
      };
      updateWalletUI();
      await updateXPDisplay();
      console.log('üîå Wallet disconnected, XP reset to 0');
    }

    function updateWalletUI() {
      const connectArea = document.getElementById('connect-area');
      const connectedArea = document.getElementById('connected-area');
      const addressEl = document.getElementById('address');

      if (appState.connected) {
        connectArea.style.display = 'none';
        connectedArea.style.display = 'block';
        addressEl.textContent = appState.address.slice(0,6) + '...' + appState.address.slice(-4);
      } else {
        connectArea.style.display = 'block';
        connectedArea.style.display = 'none';
      }
    }

    async function addXP(amount) {
      if (!appState.connected || !appState.address) {
        console.log('‚ùå Cannot add XP: wallet not connected');
        return;
      }
      
      // Get current XP from Base Mainnet
      const currentTotalXP = await getWalletXP(appState.address);
      
      // Add XP to Base Mainnet only
      const baseKey = `${appState.address.toLowerCase()}_base`;
      const currentBaseXP = parseInt(localStorage.getItem(`wallet_xp_${baseKey}`) || '0');
      const newBaseXP = currentBaseXP + amount;
      
      // Update appState with total XP
      appState.xp = currentTotalXP + amount;
      
      // Update display immediately
      document.getElementById('xp').textContent = appState.xp;
      
      // Save to localStorage (persistent, never deleted)
      localStorage.setItem(`wallet_xp_${baseKey}`, newBaseXP.toString());
      console.log(`üíæ XP saved to localStorage: ${newBaseXP}`);
      
      // Add celebration effect
      const xpElement = document.getElementById('xp');
      xpElement.style.transform = 'scale(1.2)';
      xpElement.style.color = '#00ff00';
      
      setTimeout(() => {
        xpElement.style.transform = 'scale(1)';
        xpElement.style.color = 'white';
      }, 500);
      
      console.log(`‚ú® XP added to Base Mainnet: +${amount}, Base XP: ${newBaseXP}, Total Available: ${appState.xp}`);
    }

    function showStatus(id, message, type) {
      const el = document.getElementById(id);
      el.textContent = message;
      el.className = `status visible ${type}`;
    }

    function hideStatus(id) {
      document.getElementById(id).className = 'status';
    }

    function showError(message) {
      const div = document.createElement('div');
      div.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(255,0,0,0.9);color:white;padding:10px 20px;border-radius:8px;z-index:1000;';
      div.textContent = message;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 5000);
    }

    // Real transaction function
    async function executeTransaction(contractAddress, abi, methodName, statusId, successMsg, xpAmount) {
      if (!appState.connected) {
        showError('Connect wallet first');
        return;
      }

      if (appState.isTransactionPending) {
        showError('Please wait for the current transaction to complete');
        return;
      }

      // Check if contracts are deployed on current network
      if (contractAddress === "0x0000000000000000000000000000000000000000") {
        const networkName = NETWORK.name;
        showError(`${networkName} contracts not deployed yet. Please deploy contracts first.`);
        return;
      }

      try {
        console.log('üîó Starting transaction:', methodName);
        
        // Disable all action buttons
        disableAllActionButtons();
        
        showStatus(statusId, 'Preparing transaction...', 'pending');

        // Ensure correct network (Base Mainnet)
        await ensureCorrectNetwork();

        // Create contract instance
        console.log('üîó Creating contract with signer:', appState.signer);
        const contract = new ethers.Contract(contractAddress, abi, appState.signer);
        
        // Show appropriate status message (Base Mainnet only)
        if (methodName === 'playSlots') {
          showStatus(statusId, 'üé∞ Please confirm slots game...', 'pending');
        } else {
          const feeAmount = '0.000005 ETH';
          showStatus(statusId, `üîê Please confirm transaction (${feeAmount} fee)...`, 'pending');
        }

        // Send transaction with fee (Base Mainnet only)
        let txOptions = {
          gasLimit: 100000
        };
        
        // Base Mainnet - always send fee
        if (methodName === 'playSlots') {
          txOptions.value = ethers.utils.parseEther("0.00001"); // 0.00001 ETH fee for slots
          console.log('üí∞ Base slots fee: 0.00001 ETH');
        } else {
          txOptions.value = ethers.utils.parseEther("0.000005"); // 0.000005 ETH fee for pet, greet, flip
          console.log('üí∞ Base fee: 0.000005 ETH');
        }
        
        const tx = await contract[methodName](txOptions);

        console.log('‚úÖ Transaction sent:', tx.hash);
        showStatus(statusId, `‚úÖ Transaction sent: ${tx.hash.slice(0,10)}...`, 'pending');

        // Since Farcaster wallet doesn't support eth_getTransactionReceipt,
        // we'll assume success after a delay
        setTimeout(async () => {
          console.log('‚úÖ Transaction assumed successful');
          showStatus(statusId, successMsg, 'success');
          await addXP(xpAmount);
          
          // Enable all buttons
          enableAllActionButtons();
          
          setTimeout(() => hideStatus(statusId), 3000);
        }, 5000);

      } catch (error) {
        console.error('‚ùå Transaction error:', error);
        
        // Enable all buttons on error
        enableAllActionButtons();
        
        let errorMsg = 'Transaction failed';
        if (error.message.includes('user rejected') || error.code === 4001) {
          errorMsg = 'Transaction cancelled by user';
        } else if (error.message.includes('insufficient funds')) {
          if (methodName === 'playSlots') {
            errorMsg = 'Insufficient ETH for slots game';
          } else {
            errorMsg = 'Insufficient ETH for transaction fee (need 0.000005 ETH)';
          }
        } else if (error.message.includes('Insufficient fee')) {
          if (methodName === 'playSlots') {
            errorMsg = 'Insufficient ETH for slots game';
          } else {
            errorMsg = 'Insufficient ETH for transaction fee (need 0.000005 ETH)';
          }
        }

        showStatus(statusId, errorMsg, 'error');
        setTimeout(() => hideStatus(statusId), 5000);
      }
    }

    async function ensureCorrectNetwork() {
      const network = NETWORK;
      
      try {
        const provider = sdk && sdk.wallet && sdk.wallet.ethProvider 
          ? sdk.wallet.ethProvider 
          : window.ethereum;

        if (!provider) {
          throw new Error('No wallet provider available');
        }

        const chainId = await provider.request({ method: 'eth_chainId' });
        console.log('Current chain ID:', chainId);

        if (chainId !== network.chainId) {
          console.log(`Switching to ${network.name}...`);
          
          try {
            await provider.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: network.chainId }],
            });
            console.log(`Switched to ${network.name}`);
          } catch (switchError) {
            if (switchError.code === 4902) {
              console.log(`Adding ${network.name}...`);
              await provider.request({
                method: 'wallet_addEthereumChain',
                params: [{
                  chainId: network.chainId,
                  chainName: network.name,
                  nativeCurrency: network.nativeCurrency,
                  rpcUrls: [network.rpcUrl],
                  blockExplorerUrls: [network.blockExplorer]
                }]
              });
              console.log(`${network.name} added`);
            }
          }

          // Recreate provider after network switch
          appState.provider = new ethers.providers.Web3Provider(provider);
          appState.signer = appState.provider.getSigner();
          
          console.log('üîÑ Provider and signer recreated for', network.name);
        }
      } catch (error) {
        console.error('Network switch error:', error);
        throw new Error(`Failed to switch to ${network.name}`);
      }
    }

    // Legacy function for backward compatibility

    // Farcaster Sharing Functions
    function generateShareableContent(type, data = {}) {
      const baseUrl = window.location.origin;
      const tokenBalance = document.getElementById('walletDogDisplay')?.textContent || '0';
      
      const shareTemplates = {
        pet: {
          text: `Just petted the dog on Tx App! üêï‚ú®\n\nXP earned: ${appState.xp}\n\nJoin me on Base Mainnet!`,
          url: `${baseUrl}?ref=pet&xp=${appState.xp}`,
          image: "üêï"
        },
        greet: {
          text: `GM Base community! ‚òÄÔ∏èüëã\n\nCommunity XP: ${appState.xp}\n\nSpread the love on Base Mainnet!`,
          url: `${baseUrl}?ref=greet&xp=${appState.xp}`,
          image: "üëã"
        },
        flip: {
          text: `Just flipped a coin on Tx App! ü™ô\n\nResult: ${data.result || 'Lucky'}\nXP: ${appState.xp}\n\nTry on Base Mainnet!`,
          url: `${baseUrl}?ref=flip&result=${data.result}&xp=${appState.xp}`,
          image: "ü™ô"
        },
        slots: {
          text: `Just hit the slots on Tx App! üé∞\n\nResult: ${data.result || 'Spinning'}\nXP: ${appState.xp}\n\nTry your luck on Base Mainnet!`,
          url: `${baseUrl}?ref=slots&xp=${appState.xp}`,
          image: "üé∞"
        },
        claim: {
          text: `Just claimed ${data.amount || 0} $DOG tokens! üí∞\n\nTotal $DOG Balance: ${tokenBalance}\nXP reset - earning again!\n\nEarn XP and claim your $DOG tokens too!`,
          url: `${baseUrl}?ref=claim&tokens=${data.amount}`,
          image: "üí∞"
        },
        invite: {
          text: `Playing Tx App on Base Mainnet! üöÄ\n\n‚ú® Deploy tokens, pet dogs, flip coins, say GM/GN\nüéØ Earn XP and play games\nüöÄ Real blockchain interactions\n\nJoin me!`,
          url: `https://monad-snowy.vercel.app?ref=invite&inviter=${appState.address?.slice(0,6)}`,
          image: "üöÄ"
        },
        deploy: {
          text: `Just deployed ${data.tokenName} ($${data.tokenSymbol}) on ${data.network}! üöÄ\n\nüí∞ Supply: ${data.initialSupply}\nüéØ Earned 250 XP\n\nDeploy your own token now!`,
          url: `https://monad-snowy.vercel.app?ref=deploy&token=${data.tokenSymbol}&network=${data.network}`,
          image: "üöÄ"
        },
        deploy_feature: {
          text: `Deploy your own ERC20 tokens on ${data.network}! üöÄ\n\nüí∞ ${data.fee}\nüéØ Earn 250 XP per deployment\nüì¢ Share for +50 XP\n\nTry it now!`,
          url: `https://monad-snowy.vercel.app?ref=deploy_feature&network=${data.network}`,
          image: "üöÄ"
        }
      };
      
      return shareTemplates[type] || shareTemplates.invite;
    }

    function shareOnFarcaster(content) {
      try {
        if (sdk && sdk.actions && sdk.actions.openUrl) {
          // Use Farcaster SDK for sharing
          const shareUrl = `https://warpcast.com/~/compose?text=${encodeURIComponent(content.text)}&embeds[]=${encodeURIComponent(content.url)}`;
          sdk.actions.openUrl(shareUrl);
          console.log('üöÄ Shared via Farcaster SDK');
        } else {
          // Fallback to direct URL
          const shareUrl = `https://warpcast.com/~/compose?text=${encodeURIComponent(content.text)}&embeds[]=${encodeURIComponent(content.url)}`;
          window.open(shareUrl, '_blank');
          console.log('üöÄ Shared via direct URL');
        }
        
        // Award XP for sharing (only for deploy-related shares)
        if (window.currentAchievement && (window.currentAchievement.type === 'deploy' || window.currentAchievement.type === 'deploy_feature')) {
          addXP(50);
          updateSlotsButton();
          console.log('üéâ +50 XP for sharing deploy achievement!');
        }
        
        // Track sharing event
        console.log('üìä Share event tracked:', content);
        
      } catch (error) {
        console.error('‚ùå Share error:', error);
        showError('Failed to open share dialog');
      }
    }

    // Achievement Modal Functions
    window.showAchievementModal = function(achievement) {
      const modal = document.getElementById('achievementModal');
      const icon = document.getElementById('achievementIcon');
      const title = document.getElementById('achievementTitle');
      const description = document.getElementById('achievementDescription');
      
      if (!modal || !icon || !title || !description) {
        console.error('Achievement modal elements not found');
        return;
      }
      
      icon.textContent = achievement.icon || 'üéâ';
      title.textContent = achievement.title || 'Achievement!';
      description.textContent = achievement.description || '';
      
      modal.style.display = 'flex';
      
      // Store current achievement for sharing
      window.currentAchievement = achievement;
      
      // Add escape key listener
      window.achievementEscapeHandler = function(e) {
        if (e.key === 'Escape') {
          closeAchievementModal();
        }
      };
      document.addEventListener('keydown', window.achievementEscapeHandler);
      
      console.log('üéâ Achievement modal shown:', achievement);
    }

    // Individual Share Functions
    window.sharePetAchievement = function() {
      if (!appState.connected) {
        showError('Connect wallet to share achievements');
        return;
      }
      
      const achievement = {
        icon: 'üêï',
        title: 'Dog Lover Achievement!',
        description: `You've been petting dogs and earned ${appState.xp} XP!`,
        type: 'pet',
        data: {}
      };
      
      showAchievementModal(achievement);
    };

    window.shareGreetAchievement = function() {
      if (!appState.connected) {
        showError('Connect wallet to share achievements');
        return;
      }
      
      const achievement = {
        icon: 'üëã',
        title: 'Community Spirit!',
        description: `You've been greeting the community! Spreading love on Monad with ${appState.xp} XP.`,
        type: 'greet',
        data: {}
      };
      
      showAchievementModal(achievement);
    };

    window.shareFlipAchievement = function() {
      if (!appState.connected) {
        showError('Connect wallet to share achievements');
        return;
      }
      
      const lastResult = document.getElementById('flip-result').textContent;
      const achievement = {
        icon: 'ü™ô',
        title: 'Lucky Flipper!',
        description: `${lastResult} You've been flipping coins on Monad with ${appState.xp} XP!`,
        type: 'flip',
        data: { result: lastResult }
      };
      
      showAchievementModal(achievement);
    };

    window.shareSlotsAchievement = function() {
      if (!appState.connected) {
        showError('Connect wallet to share achievements');
        return;
      }
      
      const achievement = {
        icon: 'üé∞',
        title: 'Slots Player!',
        description: `I've been playing Dog Slots on Monad! Current XP: ${appState.xp}. Try your luck!`,
        type: 'slots',
        data: {}
      };
      
      showAchievementModal(achievement);
    };

    window.shareAppWithFriends = function() {
      const achievement = {
        icon: 'üöÄ',
        title: 'Invite Friends!',
        description: 'Share Tx App with your friends and build the community together!',
        type: 'invite',
        data: {}
      };
      
      showAchievementModal(achievement);
    };

    // Lucky Number Game Functions
    let selectedLuckyNumber = null;

    // ERC20 Token Deploy Functions
     const ERC20_BYTECODE = "0x608060405234801561000f575f5ffd5b506040516117413803806117418339818101604052810190610031919061049e565b82828160039081610042919061072d565b508060049081610052919061072d565b50505061007833670de0b6b3a76400008361006d9190610829565b61008060201b60201c565b505050610952565b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036100f0575f6040517fec442f050000000000000000000000000000000000000000000000000000000081526004016100e791906108a9565b60405180910390fd5b6101015f838361010560201b60201c565b5050565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610155578060025f82825461014991906108c2565b92505081905550610223565b5f5f5f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20549050818110156101de578381836040517fe450d38c0000000000000000000000000000000000000000000000000000000081526004016101d593929190610904565b60405180910390fd5b8181035f5f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2081905550505b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361026a578060025f82825403925050819055506102b4565b805f5f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f82825401925050819055505b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516103119190610939565b60405180910390a3505050565b5f604051905090565b5f5ffd5b5f5ffd5b5f5ffd5b5f5ffd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b61037d82610337565b810181811067ffffffffffffffff8211171561039c5761039b610347565b5b80604052505050565b5f6103ae61031e565b90506103ba8282610374565b919050565b5f67ffffffffffffffff8211156103d9576103d8610347565b5b6103e282610337565b9050602081019050919050565b8281835e5f83830152505050565b5f61040f61040a846103bf565b6103a5565b90508281526020810184848401111561042b5761042a610333565b5b6104368482856103ef565b509392505050565b5f82601f8301126104525761045161032f565b5b81516104628482602086016103fd565b91505092915050565b5f819050919050565b61047d8161046b565b8114610487575f5ffd5b50565b5f8151905061049881610474565b92915050565b5f5f5f606084860312156104b5576104b4610327565b5b5f84015167ffffffffffffffff8111156104d2576104d161032b565b5b6104de8682870161043e565b935050602084015167ffffffffffffffff8111156104ff576104fe61032b565b5b61050b8682870161043e565b925050604061051c8682870161048a565b9150509250925092565b5f81519050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f600282049050600182168061057457607f821691505b60208210810361058757610586610530565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f600883026105e97fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826105ae565b6105f386836105ae565b95508019841693508086168417925050509392505050565b5f819050919050565b5f61062e6106296106248461046b565b61060b565b61046b565b9050919050565b5f819050919050565b61064783610614565b61065b61065382610635565b8484546105ba565b825550505050565b5f5f905090565b610672610663565b61067d81848461063e565b505050565b5b818110156106a0576106955f8261066a565b600181019050610683565b5050565b601f8211156106e5576106b68161058d565b6106bf8461059f565b810160208510156106ce578190505b6106e26106da8561059f565b830182610682565b50505b505050565b5f82821c905092915050565b5f6107055f19846008026106ea565b1980831691505092915050565b5f61071d83836106f6565b9150826002028217905092915050565b61073682610526565b67ffffffffffffffff81111561074f5761074e610347565b5b610759825461055d565b6107648282856106a4565b5f60209050601f831160018114610795575f8415610783578287015190505b61078d8582610712565b8655506107f4565b601f1984166107a38661058d565b5f5b828110156107ca578489015182556001820191506020850194506020810190506107a5565b868310156107e757848901516107e3601f8916826106f6565b8355505b6001600288020188555050505b505050505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f6108338261046b565b915061083e8361046b565b925082820261084c8161046b565b91508282048414831517610863576108626107fc565b5b5092915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6108938261086a565b9050919050565b6108a381610889565b82525050565b5f6020820190506108bc5f83018461089a565b92915050565b5f6108cc8261046b565b91506108d78361046b565b92508282019050808211156108ef576108ee6107fc565b5b92915050565b6108fe8161046b565b82525050565b5f6060820190506109175f83018661089a565b61092460208301856108f5565b61093160408301846108f5565b949350505050565b5f60208201905061094c5f8301846108f5565b92915050565b610de28061095f5f395ff3fe608060405234801561000f575f5ffd5b5060043610610091575f3560e01c8063313ce56711610064578063313ce5671461013157806370a082311461014f57806395d89b411461017f578063a9059cbb1461019d578063dd62ed3e146101cd57610091565b806306fdde0314610095578063095ea7b3146100b357806318160ddd146100e357806323b872dd14610101575b5f5ffd5b61009d6101fd565b6040516100aa9190610a5b565b60405180910390f35b6100cd60048036038101906100c89190610b0c565b61028d565b6040516100da9190610b64565b60405180910390f35b6100eb6102af565b6040516100f89190610b8c565b60405180910390f35b61011b60048036038101906101169190610ba5565b6102b8565b6040516101289190610b64565b60405180910390f35b6101396102e6565b6040516101469190610c10565b60405180910390f35b61016960048036038101906101649190610c29565b6102ee565b6040516101769190610b8c565b60405180910390f35b610187610333565b6040516101949190610a5b565b60405180910390f35b6101b760048036038101906101b29190610b0c565b6103c3565b6040516101c49190610b64565b60405180910390f35b6101e760048036038101906101e29190610c54565b6103e5565b6040516101f49190610b8c565b60405180910390f35b60606003805461020c90610cbf565b80601f016020809104026020016040519081016040528092919081815260200182805461023890610cbf565b80156102835780601f1061025a57610100808354040283529160200191610283565b820191905f5260205f20905b81548152906001019060200180831161026657829003601f168201915b5050505050905090565b5f5f610297610467565b90506102a481858561046e565b600191505092915050565b5f600254905090565b5f5f6102c2610467565b90506102cf858285610480565b6102da858585610513565b60019150509392505050565b5f6012905090565b5f5f5f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20549050919050565b60606004805461034290610cbf565b80601f016020809104026020016040519081016040528092919081815260200182805461036e90610cbf565b80156103b95780601f10610390576101008083540402835291602001916103b9565b820191905f5260205f20905b81548152906001019060200180831161039c57829003601f168201915b5050505050905090565b5f5f6103cd610467565b90506103da818585610513565b600191505092915050565b5f60015f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054905092915050565b5f33905090565b61047b8383836001610603565b505050565b5f61048b84846103e5565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff81101561050d57818110156104fe578281836040517ffb8f41b20000000000000000000000000000000000000000000000000000000081526004016104f593929190610cfe565b60405180910390fd5b61050c84848484035f610603565b5b50505050565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610583575f6040517f96c6fd1e00000000000000000000000000000000000000000000000000000000815260040161057a9190610d33565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036105f3575f6040517fec442f050000000000000000000000000000000000000000000000000000000081526004016105ea9190610d33565b60405180910390fd5b6105fe8383836107d2565b505050565b5f73ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1603610673575f6040517fe602df0500000000000000000000000000000000000000000000000000000000815260040161066a9190610d33565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036106e3575f6040517f94280d620000000000000000000000000000000000000000000000000000000081526004016106da9190610d33565b60405180910390fd5b8160015f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f208190555080156107cc578273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040516107c39190610b8c565b60405180910390a35b50505050565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610822578060025f8282546108169190610d79565b925050819055506108f0565b5f5f5f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20549050818110156108ab578381836040517fe450d38c0000000000000000000000000000000000000000000000000000000081526004016108a293929190610cfe565b60405180910390fd5b8181035f5f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2081905550505b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610937578060025f8282540392505081905550610981565b805f5f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f82825401925050819055505b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516109de9190610b8c565b60405180910390a3505050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f610a2d826109eb565b610a3781856109f5565b9350610a47818560208601610a05565b610a5081610a13565b840191505092915050565b5f6020820190508181035f830152610a738184610a23565b905092915050565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610aa882610a7f565b9050919050565b610ab881610a9e565b8114610ac2575f5ffd5b50565b5f81359050610ad381610aaf565b92915050565b5f819050919050565b610aeb81610ad9565b8114610af5575f5ffd5b50565b5f81359050610b0681610ae2565b92915050565b5f5f60408385031215610b2257610b21610a7b565b5b5f610b2f85828601610ac5565b9250506020610b4085828601610af8565b9150509250929050565b5f8115159050919050565b610b5e81610b4a565b82525050565b5f602082019050610b775f830184610b55565b92915050565b610b8681610ad9565b82525050565b5f602082019050610b9f5f830184610b7d565b92915050565b5f5f5f60608486031215610bbc57610bbb610a7b565b5b5f610bc986828701610ac5565b9350506020610bda86828701610ac5565b9250506040610beb86828701610af8565b9150509250925092565b5f60ff82169050919050565b610c0a81610bf5565b82525050565b5f602082019050610c235f830184610c01565b92915050565b5f60208284031215610c3e57610c3d610a7b565b5b5f610c4b84828501610ac5565b91505092915050565b5f5f60408385031215610c6a57610c69610a7b565b5b5f610c7785828601610ac5565b9250506020610c8885828601610ac5565b9150509250929050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f6002820490506001821680610cd657607f821691505b602082108103610ce957610ce8610c92565b5b50919050565b610cf881610a9e565b82525050565b5f606082019050610d115f830186610cef565b610d1e6020830185610b7d565b610d2b6040830184610b7d565b949350505050565b5f602082019050610d465f830184610cef565b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f610d8382610ad9565b9150610d8e83610ad9565b9250828201905080821115610da657610da5610d4c565b5b9291505056fea2646970667358221220800f37212cab73cfbd04a1e874c540da4f34fbc590f8445b0bcc6fe2a8dfbec964736f6c634300081e0033"
    
    
    
    window.selectLuckyNumber = function(number) {
        selectedLuckyNumber = number;
        
        // Update UI
        document.querySelectorAll('.number-btn').forEach(btn => {
          btn.classList.remove('selected');
        });
        
        // Find and select the clicked button
        const buttons = document.querySelectorAll('.number-btn');
        buttons.forEach(btn => {
          if (btn.textContent.trim() === number.toString()) {
            btn.classList.add('selected');
          }
        });
        
        // Show selected number
        document.getElementById('selected-number').style.display = 'block';
        document.getElementById('selected-number-value').textContent = number;
        
        // Enable play button
        document.getElementById('luckyButton').disabled = false;
        
        console.log('üçÄ Selected lucky number:', number);
      };
      
    window.playLuckyNumber = async function() {
        if (!selectedLuckyNumber) {
          showError('Please select a number first');
          return;
        }
        
        if (!appState.connected || !appState.signer) {
          showError('Please connect your wallet first');
          return;
        }
        
        const luckyButton = document.getElementById('luckyButton');
        
        try {
          // Disable button during game
          luckyButton.disabled = true;
          luckyButton.textContent = 'üçÄ Playing...';
          
          console.log('üçÄ Playing Lucky Number on Base network with number:', selectedLuckyNumber);
          showStatus('lucky-status', 'üçÄ Playing your lucky number...', 'pending');
          
          // ‚úÖ REAL CONTRACT CALL - Base network with fee
          const luckyContract = new ethers.Contract(CONTRACTS.LUCKY, ABIS.LUCKY, appState.signer);
          
          // Play lucky number with fee
          const tx = await luckyContract.playLuckyNumber(selectedLuckyNumber, {
            value: ethers.utils.parseEther("0.000005"), // 0.000005 ETH fee
            gasLimit: 150000
          });
          
          console.log('‚úÖ Lucky Number transaction sent:', tx.hash);
          showStatus('lucky-status', '‚è≥ Processing result...', 'pending');
          
          // Generate result based on transaction hash for deterministic results
          const txHash = tx.hash;
          const luckyNumber = (parseInt(txHash.slice(2, 10), 16) % 10) + 1;
          const isWin = (selectedLuckyNumber === luckyNumber);
          const xpEarned = isWin ? 200 : 100;
          
          console.log('üé≤ Lucky Number result:', { guess: selectedLuckyNumber, lucky: luckyNumber, isWin, xpEarned });
          
          // Show result immediately (transaction is sent, assume success)
          setTimeout(() => {
            showLuckyResult(selectedLuckyNumber, luckyNumber, xpEarned, isWin);
            addXP(xpEarned);
            updateSlotsButton();
            
            // Reset selection
            selectedLuckyNumber = null;
            document.getElementById('selected-number').style.display = 'none';
            document.querySelectorAll('.number-btn').forEach(btn => {
              btn.classList.remove('selected');
            });
          }, 1500);
          
        } catch (error) {
          console.error('‚ùå Lucky Number error:', error);
          
          let errorMsg = 'Game failed';
          if (error.message.includes('user rejected')) {
            errorMsg = 'Game cancelled';
          } else if (error.message.includes('insufficient funds')) {
            errorMsg = 'Insufficient ETH for fee';
          }
          
          showStatus('lucky-status', errorMsg, 'error');
          setTimeout(() => hideStatus('lucky-status'), 5000);
        } finally {
          // Re-enable button
          luckyButton.disabled = false;
          luckyButton.textContent = 'üçÄ Play Lucky Number';
        }
      };
      
    function showLuckyResult(guess, luckyNumber, xpEarned, isWin) {
        if (isWin) {
          showStatus('lucky-status', `üéØ YOU WON! Lucky number was ${luckyNumber}! +${xpEarned} XP`, 'success');
        } else {
          showStatus('lucky-status', `üçÄ You lost! Lucky number was ${luckyNumber}. +${xpEarned} XP`, 'success');
        }
        
        setTimeout(() => hideStatus('lucky-status'), 5000);
      }

    // Token Deploy Functions
    window.deployToken = async function() {
      if (!appState.connected || !appState.signer) {
        showStatus('deploy-status', '‚ùå Please connect your wallet first!', 'error');
        return;
      }

      // Token deployment is available on both networks

      const tokenName = document.getElementById('tokenName').value.trim();
      const tokenSymbol = document.getElementById('tokenSymbol').value.trim();
      const initialSupply = document.getElementById('initialSupply').value;

      if (!tokenName || !tokenSymbol || !initialSupply) {
        showStatus('deploy-status', '‚ùå Please fill in all fields!', 'error');
        return;
      }

      if (tokenName.length > 20) {
        showStatus('deploy-status', '‚ùå Token name must be 20 characters or less!', 'error');
        return;
      }

      if (tokenSymbol.length > 10) {
        showStatus('deploy-status', '‚ùå Token symbol must be 10 characters or less!', 'error');
        return;
      }

      const deployButton = document.getElementById('deployButton');
      deployButton.disabled = true;
      deployButton.textContent = '‚è≥ Deploying...';

      try {
        console.log('üöÄ Starting token deployment:', { tokenName, tokenSymbol, initialSupply });
        
        // Fee logic based on network
        if (appState.currentNetwork === 'base') {
          showStatus('deploy-status', '‚è≥ Sending fee...', 'pending');

          // Send fee to specified wallet (Base network only)
          const feeWallet = '0x99344B575b83360410a0E4dCe75189EdECAcc824';
          const feeAmount = ethers.utils.parseEther('0.0001'); // 0.0001 ETH

          console.log('üí∞ Sending fee to wallet:', feeWallet);
          const feeTx = await appState.signer.sendTransaction({
            to: feeWallet,
            value: feeAmount,
            gasLimit: 21000
          });

          console.log('‚úÖ Fee transaction sent:', feeTx.hash);
          showStatus('deploy-status', '‚è≥ Fee sent, deploying token...', 'pending');

          // Wait for fee transaction (simplified - just wait a bit)
          await new Promise(resolve => setTimeout(resolve, 2000));
        } else {
          // Monad network - no fee required
          showStatus('deploy-status', '‚è≥ Deploying token (no fee required)...', 'pending');
        }

        // Deploy real ERC20 token
        console.log('üöÄ Deploying real ERC20 contract...');
        showStatus('deploy-status', '‚è≥ Deploying your token...', 'pending');
        
        // Limit string lengths for Farcaster compatibility
        const shortName = tokenName.substring(0, 20); // Limit to 20 chars
        const shortSymbol = tokenSymbol.substring(0, 10); // Limit to 10 chars
        
        console.log('üìù Using shortened parameters:', { shortName, shortSymbol, initialSupply });
        
        // Encode constructor parameters
        const supplyBigInt = BigInt(initialSupply) * BigInt(10 ** 18); // Convert to wei
        
        // Create constructor data
        const constructorData = ethers.utils.defaultAbiCoder.encode(
          ['string', 'string', 'uint256'],
          [shortName, shortSymbol, supplyBigInt]
        );
        
        const deployData = ERC20_BYTECODE + constructorData.slice(2);
        
        const deployTx = await appState.signer.sendTransaction({
          data: deployData,
          gasLimit: 2000000
        });

        console.log('‚úÖ Deploy transaction sent:', deployTx.hash);
        showStatus('deploy-status', '‚è≥ Token deployment in progress...', 'pending');

        // Wait for deployment
        await new Promise(resolve => setTimeout(resolve, 5000));

        console.log('‚úÖ Token deployed successfully!');
        showStatus('deploy-status', '‚úÖ Token deployed successfully! +250 XP earned!', 'success');

        // Award XP
        addXP(250);
        updateSlotsButton();

        console.log('üéâ Awarded 250 XP for token deployment!');
        
        // Show achievement modal for sharing
        showDeployAchievement(tokenName, tokenSymbol, initialSupply);

      } catch (error) {
        console.error('‚ùå Token deployment failed:', error);
        
        let errorMsg = 'Deployment failed';
        if (error.message.includes('user rejected')) {
          errorMsg = 'Transaction rejected by user';
        } else if (error.message.includes('insufficient funds')) {
          errorMsg = 'Insufficient funds for fee';
        } else if (error.message.includes('gas')) {
          errorMsg = 'Gas estimation failed';
        }
        
        showStatus('deploy-status', `‚ùå ${errorMsg}`, 'error');
      } finally {
        deployButton.disabled = false;
        deployButton.textContent = 'üöÄ Deploy Token';
      }
    };
    
    // Deploy Achievement Function
    window.showDeployAchievement = function(tokenName, tokenSymbol, initialSupply) {
      if (!appState.connected) {
        showError('Connect wallet to share achievements');
        return;
      }
      
      const networkName = 'Base Mainnet';
      const achievement = {
        icon: 'üöÄ',
        title: 'Token Deployed!',
        description: `Just deployed ${tokenName} ($${tokenSymbol}) on ${networkName}!\nüí∞ Supply: ${initialSupply}\nüéØ Earned 250 XP\n\nDeploy your own token now!`,
        type: 'deploy',
        data: { tokenName, tokenSymbol, initialSupply, network: networkName }
      };
      
      showAchievementModal(achievement);
    };
    
    // Share Deploy Feature Function
    window.shareDeployFeature = function() {
      const networkName = 'Base Mainnet';
      const feeText = appState.currentNetwork === 'base' ? '0.0001 ETH fee' : 'FREE';
      const achievement = {
        icon: 'üöÄ',
        title: 'Deploy Feature!',
        description: `Deploy your own ERC20 tokens on ${networkName}!\n\nüí∞ ${feeText}\nüéØ Earn 250 XP per deployment\nüì¢ Share for +50 XP\n\nTry it now!`,
        type: 'deploy_feature',
        data: { network: networkName, fee: feeText }
      };
      
      showAchievementModal(achievement);
    };
    
    
    // Start app when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }

    console.log('üì± App script loaded');
    }); // End of DOMContentLoaded
  </script>
</body>
</html>
